# VMè™šæ‹Ÿæœº

## ä»‹ç»

VMå°±æ˜¯è™šæ‹Ÿæœºï¼Œç±»å±äºVMwareä¹‹ç±»çš„ã€‚è€Œè™šæ‹Ÿæœºæ˜¯åœ¨ç¨‹åºä¸­ç”¨ä»£ç æ¥å®ç°çš„ä¸€ä¸ªè™šæ‹Ÿç³»ç»Ÿï¼Œç”¨è¿™ä¸ªè™šæ‹Ÿç³»ç»Ÿæ¥è§£é‡Šä¸€ä¸²**å­—èŠ‚ç **ã€‚

é€šä¿—çš„æ¥è¯´ï¼ŒVMå°±æ˜¯è‡ªå·±è®¾è®¡ä¸€å¥—çš„æŒ‡ä»¤é›†å’Œè§£ææŒ‡ä»¤é›†çš„è§£é‡Šå™¨ã€‚å†ç®€å•ä¸€ç‚¹å°±æ˜¯è‡ªå·±å®ç°ä¸€å¥—æ±‡ç¼–è¯­è¨€ã€‚

VMè®¾è®¡çš„ä¸»è¦æ˜¯çš„Cè¯­è¨€è§£é‡Šå™¨ï¼Œ[æ‰‹æŠŠæ‰‹æ•™Cè¯­è¨€ç¼–è¯‘å™¨è™šæ‹Ÿå™¨è®¾è®¡](<https://lotabout.me/2015/write-a-C-interpreter-2/>)ã€‚



ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéœ€è¦å¯¹æ•´ä¸ªè™šæ‹Ÿè§£é‡Šå™¨ç»“æ„è¿›è¡Œé€†å‘ï¼Œæ‰¾å‡ºå…¶ä¸­å®šä¹‰äº†ä»€ä¹ˆå‡½æ•°ï¼ŒåŠŸèƒ½ç­‰ç­‰ï¼Œè¿˜éœ€è¦ç»“åˆæä¾›çš„å­—èŠ‚ç è¿›è¡Œåˆ†æã€‚

> å­—èŠ‚ç ï¼ˆByte-codeï¼‰æ˜¯ä¸€ç§åŒ…å«æ‰§è¡Œç¨‹åºï¼Œç”±ä¸€åºåˆ— op ä»£ç /æ•°æ®å¯¹ç»„æˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¯ä¸€ç§ä¸­é—´ç ã€‚è¢«çœ‹ä½œæ˜¯**åŒ…å«ä¸€ä¸ª[æ‰§è¡Œç¨‹åº](https://baike.baidu.com/item/æ‰§è¡Œç¨‹åº)çš„äºŒè¿›åˆ¶æ–‡ä»¶**ï¼Œæ›´åƒä¸€ä¸ªå¯¹è±¡æ¨¡å‹ã€‚å­—èŠ‚ç è¢«è¿™æ ·å«æ˜¯å› ä¸ºé€šå¸¸æ¯ä¸ª opcode æ˜¯ä¸€å­—èŠ‚é•¿ï¼Œä½†æ˜¯æŒ‡ä»¤ç çš„é•¿åº¦æ˜¯å˜åŒ–çš„ã€‚æ¯ä¸ªæŒ‡ä»¤æœ‰ä» 0 åˆ° 255ï¼ˆæˆ–åå…­è¿›åˆ¶çš„ï¼š 00 åˆ°FF)çš„ä¸€å­—èŠ‚[æ“ä½œç ](https://baike.baidu.com/item/æ“ä½œç )ï¼Œè¢«å‚æ•°ä¾‹å¦‚å¯„å­˜å™¨æˆ–å†…å­˜åœ°å€è·Ÿéšã€‚

![img](https://gss1.bdstatic.com/-vo3dSag_xI4khGkpoWK1HF6hhy/baike/crop%3D0%2C17%2C512%2C338%3Bc0%3Dbaike80%2C5%2C5%2C80%2C26/sign=b769daa0c095d143ce39be634ec0ae33/b64543a98226cffcebd98911b1014a90f703eaa6.jpg)

## é¢˜ç›®ç±»å‹

VMç±»é¢˜ç›®ç°åœ¨ä¸»æµæ˜¯Pwné¢˜ï¼Œä½†ä¹Ÿæœ‰åœ¨é€†å‘çš„é¢˜ç›®ï¼Œå°‘éƒ¨åˆ†ä¹Ÿæœ‰åœ¨æ‚é¡¹ã€‚

è™½ç„¶æ˜¯æœ‰å‡ ä¸ªæ–¹å‘ï¼Œä½†æ˜¯åŸºæœ¬å½’ç»“èµ·æ¥æ˜¯ä¸¤ç±»ï¼š

1. ç»™å‡ºå¯æ‰§è¡Œç¨‹åºå’Œå­—èŠ‚ç ï¼Œé€†å‘è™šæ‹Ÿå¼•æ“ï¼ˆå®šä¹‰çš„å‡½æ•°ï¼Œè¿›è¡Œçš„æ“ä½œï¼‰ï¼Œç»“åˆé¢˜ç›®æä¾›çš„å­—èŠ‚ç ï¼Œæ¨å‡ºæ¥flag

2. åªç»™å‡ºå¯æ‰§è¡Œç¨‹åºï¼Œé€†å‘è™šæ‹Ÿå¼•æ“ï¼ˆå®šä¹‰çš„å‡½æ•°ï¼Œè¿›è¡Œçš„æ“ä½œï¼‰ï¼Œæ„é€ å­—èŠ‚ç ï¼Œè¯»å–flag

   

## åšé¢˜æŠ€å·§

> æ¥è‡ª[ä¸€ç­èåœ](<https://radishes.top/>)

å½“åœ¨æ‰“CTFæ‹¿åˆ°ä¸€ä¸ªVMé¢˜çš„æ—¶å€™ï¼Œæ€è·¯ä¸€å®šæ¸…æ™°ï¼Œä¸èƒ½ç›²ç›®çš„å»åˆ†æï¼›

1. åˆ†æè™šæ‹Ÿæœºå…¥å£ï¼Œæ‰¾å‡ºæ¥é¢˜ç›®æä¾›çš„å­—èŠ‚ç 
2. ç†æ¸…è™šæ‹Ÿæœºçš„ç»“æ„ï¼Œé€†å‘å¤„å„ä¸ªhandlerçš„æ„æ€
3. æ ¹æ®å„ä¸ªhandleræ¥å°†å­—èŠ‚ç è¿˜åŸæˆæ±‡ç¼–ä»£ç 
4. æ ¹æ®æ±‡ç¼–ä»£ç æ¨å‡ºflag

å¦‚æœåŠ¨æ€è°ƒè¯•åˆ†æçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå¾ˆå¤æ‚ï¼Œè·³æ¥è·³å»çš„ï¼Œæ‰€ä»¥å»ºè®®å…ˆç”¨IDAæ¥é™æ€åˆ†æã€‚

![](https://raw.githubusercontent.com/skyedai910/Picbed/master/img/20191210235228.png)



## ğŸŒ°ä¾‹å­

### çº¢å¸½æ¯RHVM

åˆå§‹åŒ–å‡½æ•°æ‰“å¼€äº† flag æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ [dup2](<https://baike.baidu.com/item/dup2>) å°†[æ–‡ä»¶æè¿°ç¬¦](https://baike.baidu.com/item/æ–‡ä»¶æè¿°ç¬¦)é‡å®šå‘åˆ° 563 ã€‚

```c
fd = open("/flag", 0);
if ( fd == -1 )
{
  puts("What?");
  exit(-1);
}
dup2(fd, 563);
```

åœ¨æ‰§è¡Œå®Œ main å‡½æ•°åä¼šè·³è½¬åˆ°è¿™é‡Œã€‚å¦‚æœå°†stdinçš„filenoä¿®æ”¹ä¸º563ï¼Œé‚£ä¹ˆè¿™é‡Œscanfä¼šè¯»å–åˆ°flagï¼Œç„¶ååœ¨ä¸‹ä¸€è¡Œçš„printfè¾“å‡ºflagã€‚

```c
printf("Could you tell me your name?");
__isoc99_scanf("%99s", &v0);
printf("Goodbye~ %s\n", &v0);
puts("See you next time.");
exit(0);
```

 æ‰¾åˆ°VMå®šä¹‰çš„å…¥å£ï¼Œé€†å‘å‡ºè™šæ‹Ÿå¼•æ“ã€‚æ‰¾åˆ°å¼•æ“ä¸­å®šä¹‰çš„ MovDataToReg å’Œ MovRegToData å¯ä»¥è¶Šç•Œè¯»å–Dataæ®µã€‚

å…·ä½“WPï¼Œ[çœ‹è¿™é‡Œ](http://dittozzz.top/2019/11/25/2019çº¢å¸½æ¯finalä¸‰é“pwnçš„wp/)ã€‚



### çº¢å¸½æ¯PVP GAME

ç¨‹åºè¯»å–è¾“å…¥åï¼Œå¯¹è¾“å…¥çš„å­—ç¬¦ä¸²è¿›è¡Œbase64è§£ç 

```c
_BYTE *__fastcall Base64Decode(const char *src)
{
  int v2; // [rsp+10h] [rbp-220h]
  int v3; // [rsp+14h] [rbp-21Ch]
  signed __int64 OrignLen; // [rsp+18h] [rbp-218h]
  signed __int64 len; // [rsp+20h] [rbp-210h]
  _BYTE *dest; // [rsp+28h] [rbp-208h]
  int v7[126]; // [rsp+30h] [rbp-200h]
  unsigned __int64 v8; // [rsp+228h] [rbp-8h]

  qmemcpy(v7, &unk_1B60, 0x1ECuLL);
  len = strlen(src);
  if ( strstr(src, "==") )                      // base64
  {
    OrignLen = 3 * (len / 4) - 2;
  }
  else if ( strchr(src, '=') )
  {
    OrignLen = 3 * (len / 4) - 1;
  }
  else
  {
    OrignLen = 3 * (len / 4);
  }
  dest = calloc(1uLL, OrignLen + 1);
  dest[OrignLen] = 0;
  v2 = 0;
  v3 = 0;
  while ( v2 < len - 2 )
  {
    dest[v3] = ((unsigned __int8)v7[(unsigned __int8)src[v2 + 1]] >> 4) | 4 * v7[(unsigned __int8)src[v2]];
    dest[v3 + 1] = ((unsigned __int8)v7[(unsigned __int8)src[v2 + 2]] >> 2) | 16 * v7[(unsigned __int8)src[v2 + 1]];
    dest[v3 + 2] = LOBYTE(v7[(unsigned __int8)src[v2 + 3]]) | ((unsigned __int8)v7[(unsigned __int8)src[v2 + 2]] << 6);
    v3 += 3;
    v2 += 4;
  }
  return dest;
}
```

ç„¶åè¿è¡Œdefenceæ–‡ä»¶æä¾›çš„å­—èŠ‚ç æ¥å¯¹è¾“å…¥çš„codeè¿›è¡Œæ£€æŸ¥ã€‚æœ€åè¿è¡Œè¾“å…¥çš„å­—èŠ‚ç ã€‚

```c
for ( j = 0; j <= 15; ++j )
  RunOpcode(Defence, a2, 24LL * j, a4, a5, a6, Code[j].opcode, Code[j].arg1, Code[j].arg2);
return puts("Game Over!");
```

è¾“å…¥çš„å­—èŠ‚ç æ˜¯å‹å…¥æ•°æ®å’Œæ‰§è¡Œå‡½æ•°ã€‚å› ä¸ºç¨‹åºå¼€å§‹å°±ç»™å‡ºäº† libc  çš„åœ°å€ï¼Œæ‰€ä»¥å°±è§£é¢˜çš„å…³é”®å°±æ˜¯é€†å‘å‡ºè™šæ‹Ÿå¼•æ“çš„å†…å®¹ã€‚

å…·ä½“WPï¼Œ[çœ‹è¿™é‡Œ](http://dittozzz.top/2019/11/25/2019çº¢å¸½æ¯finalä¸‰é“pwnçš„wp/)ã€‚



### å—é‚®WxyVM1

ä» main å‡½æ•°çœ‹ï¼Œå°±æ˜¯å°† input åŠ å¯†åä¸ çœŸÂ·flag çš„åŠ å¯†å€¼å¯¹æ¯”ï¼Œç›¸åŒçš„è¾“å‡º correct ã€‚

```c
__int64 __fastcall main(__int64 a1, char **a2, char **a3)
{
  char v4; // [rsp+Bh] [rbp-5h]
  signed int i; // [rsp+Ch] [rbp-4h]

  puts("[WxyVM 0.0.1]");
  puts("input your flag:");
  scanf("%s", &input);
  v4 = 1;
  vm_start();//inputåŠ å¯†å‡½æ•°
  if ( strlen(&input) != 24 )
    v4 = 0;
  for ( i = 0; i <= 23; ++i )
  {
    if ( *(&input + i) != enc[i] )
      v4 = 0;
  }
  if ( v4 )
    puts("correct");
  else
    puts("wrong");
  return 0LL;
}
```

ä¹Ÿå°±æ˜¯è¯´å°† vm_start çš„åŠ å¯†åŸç†æå‡ºæ¥å°±å¥½äº†ã€‚å‡½æ•°é‡Œé¢è°ƒç”¨äº† byte_6010C0 è¿™ä¸ªæ•°ç»„çš„15000ä¸ªå…ƒç´ ï¼Œå…¶ä¸­æ¯ä¸‰ä¸ªä¸ºä¸€ç»„å‚åŠ ä¸€æ¬¡å¾ªç¯ã€‚byte_6010C0[i] ä½œä¸º switch çš„æ“ä½œæŒ‡ä»¤ï¼Œbyte_6010C0[i + 1] ä½œä¸º input çš„ä¸‹æ ‡ï¼Œbyte_6010C0[i + 2] ä½œä¸ºè¿›è¡Œæ“ä½œçš„æ“ä½œæ•°ã€‚

```c
__int64 vm_start()
{
  unsigned int v0; // ST04_4
  __int64 result; // rax
  signed int i; // [rsp+0h] [rbp-10h]
  char v3; // [rsp+8h] [rbp-8h]

  for ( i = 0; i <= 14999; i += 3 )
  {
    v0 = byte_6010C0[i];
    v3 = byte_6010C0[i + 2];
    result = v0;
    switch ( v0 )
    {
      case 1u:
        result = byte_6010C0[i + 1];
        *(&input + result) += v3;
        break;
      case 2u:
        result = byte_6010C0[i + 1];
        *(&input + result) -= v3;
        break;
      case 3u:
        result = byte_6010C0[i + 1];
        *(&input + result) ^= v3;
        break;
      case 4u:
        result = byte_6010C0[i + 1];
        *(&input + result) *= v3;
        break;
      case 5u:
        result = byte_6010C0[i + 1];
        *(&input + result) ^= *(&input + byte_6010C0[i + 2]);
        break;
      default:
        continue;
    }
  }
  return result;
}
```

åˆ°è¿™é‡ŒåŸºæœ¬å·²ç»æ¸…æ¥šäº†ï¼ŒæŠŠæ•°æ®éƒ½dumpä¸‹æ¥ï¼Œå†™ä¸ªè„šæœ¬é€†ä¸€ä¸‹å°±okäº†ã€‚ç„¶åè¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„è¿ç®—æ˜¯ä»¥byteä¸ºå•ä½ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæº¢å‡ºï¼Œæ‰€ä»¥åº”è¯¥æ¯æ¬¡æ“ä½œä¹‹åæ¨¡ä¸€ä¸‹256ã€‚

å…·ä½“WPï¼Œ[çœ‹è¿™é‡Œ](<https://www.52pojie.cn/forum.php?mod=viewthread&tid=828110>)ã€‚

 

### å—é‚®WxyVM2

ç¨‹åºçš„åŸºæœ¬æƒ…å†µä¸ WxyVM1 ç›¸åŒï¼Œæœ€å¤§çš„ä¸åŒå°±æ˜¯VMè™šæ‹Ÿå¼•æ“ã€‚è¿™é“é¢˜ä½¿ç”¨çš„æ˜¯ dword_69417c ~ dword_6941dc æ•°ç»„çš„å¤šæ¬¡æ··åˆè¿ç®—ã€‚